---
ver: rpa2
title: On gauge freedom, conservativity and intrinsic dimensionality estimation in
  diffusion models
arxiv_id: '2402.03845'
source_url: https://arxiv.org/abs/2402.03845
tags:
- diffusion
- conservative
- equation
- vector
- freedom
- transformers
- self-attention
- retrieval-augmented-generation
- instruction-tuning
- parameter-efficient-finetuning
- mixture-of-experts
- chain-of-thought
core_contribution: This paper investigates whether a diffusion model must be conservative
  (i.e., gradient of a scalar function) to achieve exact density estimation and sampling.
  While earlier work argued empirically with conflicting results, this paper provides
  theoretical analysis.
---

# On gauge freedom, conservativity and intrinsic dimensionality estimation in diffusion models

## Quick Facts
- **arXiv ID**: 2402.03845
- **Source URL**: https://arxiv.org/abs/2402.03845
- **Reference count**: 28
- **Key outcome**: This paper investigates whether a diffusion model must be conservative (i.e., gradient of a scalar function) to achieve exact density estimation and sampling. While earlier work argued empirically with conflicting results, this paper provides theoretical analysis.

## Executive Summary
This paper provides theoretical analysis of when diffusion models can achieve exact density estimation and sampling. It derives a novel orthogonal decomposition of any vector field into conservative and gauge-freedom components, showing that exact sampling and density estimation are achieved when the conservative component equals the true score. The paper demonstrates that conservativity is neither necessary nor sufficient for exactness, but is sufficient for correctly inferring local features like intrinsic dimensionality of the data manifold. Experiments on synthetic manifolds confirm that conservative diffusion models correctly estimate intrinsic dimensionality, while non-conservative models fail to do so even with regularization.

## Method Summary
The paper uses stochastic differential equations and Fokker-Planck equations to analyze diffusion models. It considers vector fields s_θ(x,t) that define the backward denoising process and can be decomposed into conservative components (gradients of scalar functions) and gauge-freedom components. The theoretical framework derives conditions under which exact density estimation and sampling are achieved, and analyzes when conservativity is sufficient for inferring local manifold properties like intrinsic dimensionality. Experiments train both conservative and non-conservative diffusion models on synthetic manifolds (spheres, tori, Swiss rolls) to compare their performance in density estimation and intrinsic dimensionality estimation.

## Key Results
- Exact density estimation and sampling are achieved when the conservative component equals the true score, and conservativity is neither necessary nor sufficient for exactness
- Conservativity is sufficient for correctly inferring local features like intrinsic dimensionality of the data manifold
- The orthogonal decomposition of vector fields provides new intuition on the score matching loss in diffusion models

## Why This Works (Mechanism)

### Mechanism 1
- Claim: A diffusion model can achieve exact sampling and density estimation without being conservative if the residual term satisfies a specific gauge freedom condition.
- Mechanism: The paper shows that any vector field in the diffusion model can be decomposed into a conservative component (which should match the true score function) and a gauge-freedom component. The gauge-freedom component must satisfy the condition ∇ · r_θ(x, t) + r_θ(x, t)^T∇ log p(x, t) = 0 for all x and t. When this condition is met, the marginal probability distributions remain unchanged, ensuring exact sampling and density estimation.
- Core assumption: The decomposition is valid for square-integrable vector fields with respect to the measure induced by p(·, t).
- Evidence anchors:
  - [abstract]: "exact density estimation and exact sampling is achieved when the conservative component is exactly equals to the true score and therefore conservativity is neither necessary nor sufficient to obtain exact density estimation and exact sampling"
  - [section 3]: The paper derives the gauge freedom condition (equation 11) and shows that whenever r_θ fulfills this condition, the density evolution remains unchanged.
- Break condition: If the gauge freedom condition is not satisfied, the density evolution changes and exact sampling/density estimation fails.

### Mechanism 2
- Claim: Conservativity is sufficient for correctly inferring local features like intrinsic dimensionality of the data manifold.
- Mechanism: When the diffusion model is conservative, the Jacobian of the backward denoising process commutes with the probability matrix P_t at sufficiently small times near the manifold. This allows the singular values of the Jacobian to properly reflect the intrinsic dimensionality - some singular values saturate while others approach zero, revealing the manifold's true dimension.
- Core assumption: The commutator [P_t(x1), ∇f_θ(ϕ_t(x1), t)] = 0 for all t ∈ [0, ε] for some ε > 0.
- Evidence anchors:
  - [abstract]: "we show that when it comes to inferring local information of the data manifold, constraining the vector field to be conservative is desirable"
  - [section 5]: Theorem 2 proves that conservativity implies the rank condition that reveals the intrinsic dimensionality.
- Break condition: If the diffusion model is not conservative, the singular values of the Jacobian will not show the expected behavior (some saturate, others approach zero), leading to incorrect intrinsic dimensionality estimation.

### Mechanism 3
- Claim: The orthogonal decomposition of vector fields provides new intuition on the score matching loss in diffusion models.
- Mechanism: The score matching loss minimizes two terms - the relevant term that measures the difference between the conservative component and the true score, and the irrelevant term that measures the magnitude of the gauge-freedom component. Only the first term affects sampling and density estimation.
- Core assumption: The decomposition is orthogonal in L²(p), meaning the conservative and gauge-freedom components are perpendicular in the Hilbert space.
- Evidence anchors:
  - [section 3]: Equation 13 shows how the score matching loss decomposes into two orthogonal terms.
  - [section 3]: Theorem 1 proves the orthogonality of the decomposition.
- Break condition: If the orthogonality assumption fails, the decomposition would not provide the correct interpretation of the score matching loss.

## Foundational Learning

- Concept: Stochastic Differential Equations (SDEs) and Fokker-Planck equations
  - Why needed here: The paper uses SDEs to describe the forward and backward diffusion processes, and the Fokker-Planck equation to analyze how probability densities evolve over time.
  - Quick check question: What is the relationship between the backward ODE in equation (2) and the Fokker-Planck equation (equation 7)?

- Concept: Gauge freedom in vector fields
  - Why needed here: The paper introduces the concept of gauge freedom to explain how diffusion models can achieve exactness without being conservative.
  - Quick check question: What condition must the gauge-freedom component satisfy according to equation (11)?

- Concept: Intrinsic dimensionality of manifolds
  - Why needed here: The paper uses intrinsic dimensionality estimation as a case study to demonstrate when conservativity matters.
  - Quick check question: How does the evolution of singular values of the Jacobian relate to the intrinsic dimensionality of the data manifold?

## Architecture Onboarding

- Component map: Data point x and time t -> Neural network s_θ(x,t) -> Vector in R^D (score estimate)
- Critical path: Sampling from p(x,1) -> Solving backward ODE using s_θ to generate samples at earlier times -> Computing density using instantaneous change of variables formula
- Design tradeoffs: Unconstrained s_θ offers more architectural flexibility but may not learn the true score exactly. Conservative s_θ guarantees certain local properties but requires additional computation (e.g., computing gradients of scalar functions) and may limit architectural choices.
- Failure signatures: If the gauge freedom condition is violated, the density evolution will be incorrect. If the diffusion model is not conservative when analyzing local features, the singular values of the Jacobian will not show the expected behavior, leading to incorrect intrinsic dimensionality estimation.
- First 3 experiments:
  1. Implement the gauge freedom condition check for a trained diffusion model on a synthetic Gaussian dataset.
  2. Compare intrinsic dimensionality estimation using conservative vs non-conservative diffusion models on a Swiss roll dataset.
  3. Analyze how the score matching loss decomposes into relevant and irrelevant terms for different diffusion model architectures.

## Open Questions the Paper Calls Out

### Open Question 1
- Question: Is the gauge freedom condition (equation 11) empirically achievable in practice for diffusion models, or is it too restrictive?
- Basis in paper: [explicit] The paper states that enforcing the gauge freedom conditions may be challenging in practice since it requires access to the true score function, and suggests adding penalty terms to enforce the conditions.
- Why unresolved: The paper leaves this as an open direction for future work, acknowledging that enforcing the gauge freedom conditions may be difficult without access to the true score function.
- What evidence would resolve it: Empirical experiments demonstrating whether adding penalty terms to enforce the gauge freedom conditions improves the density estimation and sampling performance of diffusion models, compared to unconstrained models.

### Open Question 2
- Question: Can the conditions of Theorem 2 be relaxed to accommodate non-conservative vector fields, while still allowing for accurate intrinsic dimensionality estimation?
- Basis in paper: [inferred] The paper states that Theorem 2 requires the diffusion model to be conservative and provides exact sampling and density estimation. It also mentions that relaxing the conditions to accommodate non-conservative vector fields is an interesting direction to pursue.
- Why unresolved: The paper does not provide any theoretical or empirical results for non-conservative vector fields, leaving it as an open question.
- What evidence would resolve it: Theoretical analysis or empirical experiments demonstrating whether intrinsic dimensionality can be accurately estimated using non-conservative diffusion models, and under what conditions.

### Open Question 3
- Question: How does the gauge freedom in diffusion models relate to the recently proposed "action matching" method for learning stochastic dynamics from samples?
- Basis in paper: [explicit] The paper mentions that the recently proposed "action matching" method (Neklyudov et al., 2023) may be more suited for applications where a consistent score function is desired, implying a potential connection to the gauge freedom concept.
- Why unresolved: The paper does not explore the relationship between gauge freedom and action matching in detail, leaving it as an open question.
- What evidence would resolve it: A theoretical or empirical comparison of the gauge freedom approach and the action matching method, highlighting their similarities, differences, and relative strengths in various scenarios.

## Limitations

- Experiments focus on synthetic manifolds where ground truth properties are known, limiting generalizability to real-world datasets
- The theoretical conditions for exact sampling (equation 11) require precise control over the residual term, which may be difficult to verify or enforce in practice
- Empirical validation is limited to controlled synthetic scenarios, with unknown performance on complex, high-dimensional real data

## Confidence

- **High confidence**: Theoretical framework for conservative vs non-conservative decomposition, sufficient conditions for correct intrinsic dimensionality estimation
- **Medium confidence**: Practical implications and empirical validation on synthetic manifolds
- **Low confidence**: Generalizability to complex, high-dimensional real data where manifold structure is unknown

## Next Checks

1. Test gauge freedom condition on real-world image datasets by comparing density estimates from conservative and non-conservative diffusion models.
2. Evaluate whether the orthogonal decomposition interpretation of the score matching loss holds empirically across different network architectures.
3. Investigate if the intrinsic dimensionality estimation benefits of conservative models persist when training data contains significant noise or sampling artifacts.