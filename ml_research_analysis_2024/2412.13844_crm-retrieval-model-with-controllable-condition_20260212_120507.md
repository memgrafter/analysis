---
ver: rpa2
title: 'CRM: Retrieval Model with Controllable Condition'
arxiv_id: '2412.13844'
source_url: https://arxiv.org/abs/2412.13844
tags:
- retrieval
- user
- time
- kuaishou
- item
- transformers
- self-attention
- retrieval-augmented-generation
- instruction-tuning
- parameter-efficient-finetuning
- mixture-of-experts
- chain-of-thought
core_contribution: This paper introduces a retrieval model that integrates regression
  targets as conditional features, addressing the limitation in standard two-tower
  retrieval models that only use classification targets. The proposed Controllable
  Retrieval Model (CRM) enables the retrieval stage to align better with ranking objectives,
  improving overall recommendation performance.
---

# CRM: Retrieval Model with Controllable Condition

## Quick Facts
- arXiv ID: 2412.13844
- Source URL: https://arxiv.org/abs/2412.13844
- Authors: Chi Liu; Jiangxia Cao; Rui Huang; Kuo Cai; Weifeng Ding; Qiang Luo; Kun Gai; Guorui Zhou
- Reference count: 24
- Key outcome: Retrieval model integrating regression targets as conditional features, validated through A/B testing showing significant improvements in user engagement metrics on Kuaishou's short-video recommendation system

## Executive Summary
This paper introduces the Controllable Retrieval Model (CRM), which addresses the limitation in standard two-tower retrieval models that only use classification targets by integrating regression targets as conditional features. CRM enables the retrieval stage to better align with ranking objectives by incorporating expected engagement metrics like watch time into the user representation generation process. The model was validated through A/B testing on Kuaishou's short-video recommendation system, demonstrating significant improvements in user engagement metrics including a 0.372% increase in video watch time and a 0.828% increase in follows.

## Method Summary
CRM is a two-tower retrieval model that incorporates regression information as conditional features into the user tower during training. The model can use either a DNN-based or transformer-based approach, with the transformer version (CRM_DT) using sequence modeling inspired by Decision Transformer. During training, the observed next video's watch time is input as a condition to the user tower. For online inference, a time-division multiplexing strategy randomly selects between maximum and average watch time conditions to balance competing recommendation objectives. The model is trained using in-batch softmax classification loss and employs ANN search for efficient retrieval.

## Key Results
- A/B testing on Kuaishou platform showed 0.372% increase in video watch time
- A/B testing demonstrated 0.828% increase in follows metric
- Achieved highest average time per video view among compared retrieval methods

## Why This Works (Mechanism)

### Mechanism 1
- Claim: Integrating regression information as conditional features into the two-tower retrieval model allows it to better align with ranking objectives.
- Mechanism: By incorporating the observed next video's watch time as a condition in the user tower during training, the model learns to generate user representations that are more sensitive to expected engagement levels. This enables the retrieval stage to produce candidates that are not only relevant to user interests but also likely to achieve higher engagement as measured by watch time.
- Core assumption: The regression target (e.g., expected watch time) can be inferred from user-side information when conditioned on past interactions.
- Evidence anchors:
  - [abstract] "CRM... integrates regression information as conditional features into the two-tower retrieval paradigm. This modification enables the retrieval stage could fulfill the target gap with ranking model..."
  - [section] "In the model training, we directly input the observed next video's watch time ùë§ùëõ+1 as a condition to the user tower..."
- Break condition: If the relationship between user-side features and the regression target is too weak or non-existent for certain user-item pairs, the condition may not effectively guide retrieval.

### Mechanism 2
- Claim: Using a transformer-based approach with sequence modeling allows for stronger incorporation of regression conditions into retrieval.
- Mechanism: The CRM model constructs a sequence with watch-time-to-go and items, using a multi-layer Transformer with causal masking. This enables the model to capture complex dependencies between past interactions, the condition, and the next item prediction, leading to more accurate and engaging recommendations.
- Core assumption: The sequence of past interactions and watch times contains sufficient information to predict the next item when conditioned on the regression target.
- Evidence anchors:
  - [section] "Inspired by the Decision Transformer [3], we form the user's interaction sequence as RL-based sequence style..."
  - [section] "In our online production environment, we opted for the transformer-based CRM due to its superior performance."
- Break condition: If the sequence length is too short or the watch time information is not representative, the sequence modeling may not capture the necessary patterns.

### Mechanism 3
- Claim: A time-division multiplexing strategy for condition setting during online inference balances the trade-off between maximizing watch time and maintaining interaction metrics.
- Mechanism: By randomly selecting between using the maximum watch time or the average watch time as the condition for each request, the model can leverage the strengths of both strategies at different times, appearing to coexist for individual users. This prevents the model from being overly biased towards either long videos or frequent interactions.
- Core assumption: Both the maximum and average watch time strategies have distinct benefits, and their random selection can effectively balance the recommendation objectives.
- Evidence anchors:
  - [section] "To leverage the strengths of both strategies, we adopt a time-division multiplexing approach..."
  - [section] "In our real-world online deployment, We selected 32 as the value of ùëõ."
- Break condition: If the probability of selecting each strategy (p) is not optimized, the balance may be skewed, leading to suboptimal performance.

## Foundational Learning

- Concept: Two-Tower Retrieval Architecture
  - Why needed here: Understanding the basic structure of two-tower models is crucial for grasping how CRM modifies this architecture to incorporate regression conditions.
  - Quick check question: In a standard two-tower model, how are user and item representations generated, and what is the primary objective function used during training?

- Concept: Decision Transformer and Reinforcement Learning
  - Why needed here: CRM uses a transformer-based approach inspired by Decision Transformer, so familiarity with sequence modeling and RL concepts is necessary to understand its implementation.
  - Quick check question: How does Decision Transformer use reward-to-go tokens and causal masking to model sequential decision-making problems?

- Concept: Multi-Stage Recommendation Systems
  - Why needed here: CRM aims to bridge the gap between retrieval and ranking stages, so understanding the typical flow and objectives of each stage is important for appreciating its benefits.
  - Quick check question: What are the main differences between the objectives and available information in the retrieval and ranking stages of a recommendation system?

## Architecture Onboarding

- Component map:
  - User Tower: Encodes user features and incorporates regression condition
  - Item Tower: Encodes item features (unchanged from standard two-tower)
  - Condition Generator: Determines the value of the regression condition during online inference
  - Transformer Module (CRM_DT): Processes the sequence of interactions and conditions for sequence modeling
  - ANN Search: Performs approximate nearest neighbor search using the conditioned user representations

- Critical path:
  1. User features and regression condition are input to the User Tower
  2. Item features are input to the Item Tower
  3. User and item representations are compared using a similarity function
  4. Top-k items are retrieved using ANN search
  5. Retrieved items are scored by the ranking stage

- Design tradeoffs:
  - DNN-based vs. Transformer-based CRM: The DNN-based approach is simpler to implement but may not capture complex dependencies as well as the transformer-based approach. The transformer-based approach requires more computational resources but offers superior performance.
  - Condition selection strategy: Using maximum watch time boosts overall watch time but may reduce interaction metrics, while using average watch time has the opposite effect. The time-division multiplexing strategy aims to balance these trade-offs.

- Failure signatures:
  - Poor retrieval quality: If the regression condition is not informative or the model fails to incorporate it effectively, the retrieved items may not be relevant or engaging.
  - Performance degradation: If the condition generation strategy is not optimized, it may lead to suboptimal recommendations and reduced user engagement metrics.

- First 3 experiments:
  1. Ablation study comparing CRM with and without the regression condition to quantify its impact on retrieval quality.
  2. Offline evaluation of different condition generation strategies (maximum vs. average watch time) to determine the optimal approach for the target platform.
  3. Online A/B testing of CRM against baseline retrieval methods to measure improvements in key metrics such as watch time, video views, and user interactions.

## Open Questions the Paper Calls Out

### Open Question 1
- Question: How can regression targets be effectively incorporated into retrieval models beyond the two-tower architecture?
- Basis in paper: [explicit] The paper highlights that retrieval models typically use only classification targets due to the two-tower architecture's limitation in supporting multi-target training, especially regression targets. The proposed CRM integrates regression information as conditional features, but the paper does not explore alternative architectures.
- Why unresolved: The paper focuses on the two-tower architecture and does not investigate other potential architectures that might better support regression targets.
- What evidence would resolve it: Experimental comparisons of retrieval models using alternative architectures (e.g., multi-gate experts, hierarchical models) with regression targets, showing improvements in performance metrics.

### Open Question 2
- Question: What is the optimal strategy for setting conditions during online inference to maximize user engagement?
- Basis in paper: [explicit] The paper discusses using maximum vs. average watch time as conditions and a time-division multiplexing strategy, but notes that these are hyperparameters whose optimal values were determined through online experiments.
- Why unresolved: The paper does not provide a comprehensive analysis of different condition-setting strategies or their impact on user engagement across various scenarios.
- What evidence would resolve it: A detailed study comparing different condition-setting strategies (e.g., dynamic conditions based on user behavior) and their effects on engagement metrics like watch time and interaction rates.

### Open Question 3
- Question: How does CRM perform in domains outside of short-video recommendation?
- Basis in paper: [inferred] The paper demonstrates CRM's effectiveness in Kuaishou's short-video recommendation system but does not explore its applicability to other domains.
- Why unresolved: The paper focuses solely on short-video recommendations and does not provide evidence of CRM's performance in other recommendation scenarios or industries.
- What evidence would resolve it: Implementation and evaluation of CRM in diverse recommendation systems (e.g., e-commerce, news, music) with comparative analysis of performance improvements.

## Limitations

- The paper lacks detailed architectural specifications for the transformer-based CRM_DT implementation, making exact replication challenging
- The generalizability of the time-division multiplexing strategy for condition selection is not systematically evaluated across different user segments or platforms
- The experimental validation does not include comparisons against other state-of-the-art retrieval methods that incorporate similar conditioning mechanisms

## Confidence

**High Confidence Claims:**
- CRM's basic mechanism of incorporating regression targets as conditional features into two-tower retrieval is technically sound
- The reported A/B test results showing improvements in watch time (+0.372%), follows (+0.828%), and average time per video view are specific and verifiable
- The time-division multiplexing strategy for condition selection is a reasonable approach to balancing competing recommendation objectives

**Medium Confidence Claims:**
- The transformer-based CRM_DT provides superior performance compared to the DNN-based alternative, though exact magnitude depends on implementation details
- The assumption that user-side features contain sufficient information to infer regression targets when conditioned on past interactions appears reasonable but may vary by platform
- The claim that CRM better aligns retrieval with ranking objectives is supported by overall performance improvements but lacks direct ablation studies

**Low Confidence Claims:**
- The paper does not provide sufficient detail to confidently reproduce the exact CRM_DT architecture
- The optimal probability parameter (p) for time-division multiplexing is stated as 0.5 without systematic hyperparameter tuning

## Next Checks

1. **Architectural Replication Study**: Implement the CRM_DT architecture with varying transformer depths (2, 4, 8 layers) and attention heads (4, 8, 16) to determine the sensitivity of performance to these design choices.

2. **Conditioning Mechanism Ablation**: Conduct a controlled experiment comparing CRM with: (a) standard two-tower without conditioning, (b) two-tower with regression targets as additional features (not conditional), and (c) CRM with different condition selection strategies (maximum only, average only, random).

3. **Generalizability Test**: Evaluate CRM's performance across different recommendation domains (e.g., e-commerce, news, music) with varying item characteristics and user behavior patterns.