---
ver: rpa2
title: 'EP-CFG: Energy-Preserving Classifier-Free Guidance'
arxiv_id: '2412.09966'
source_url: https://arxiv.org/abs/2412.09966
tags:
- ep-cfg
- level
- strengths
- column
- while
- transformers
- self-attention
- retrieval-augmented-generation
- instruction-tuning
- parameter-efficient-finetuning
- mixture-of-experts
- chain-of-thought
core_contribution: EP-CFG addresses over-contrast and over-saturation artifacts in
  classifier-free guidance by preserving the energy distribution of conditional predictions
  during diffusion. The method rescales the guided output's energy to match the conditional
  prediction at each denoising step, using either standard or robust energy estimation
  that ignores extreme pixel values.
---

# EP-CFG: Energy-Preserving Classifier-Free Guidance

## Quick Facts
- arXiv ID: 2412.09966
- Source URL: https://arxiv.org/abs/2412.09966
- Reference count: 1
- Key outcome: EP-CFG eliminates over-contrast and over-saturation artifacts in CFG at high guidance strengths while preserving natural image quality through energy preservation

## Executive Summary
EP-CFG addresses over-contrast and over-saturation artifacts in classifier-free guidance for diffusion models by preserving the energy distribution of conditional predictions during denoising. The method rescales the guided output's energy to match the conditional prediction at each step, using either standard or robust energy estimation that ignores extreme pixel values. Visual comparisons show EP-CFG maintains natural image quality across guidance strengths while preserving semantic alignment benefits, with minimal computational overhead.

## Method Summary
EP-CFG modifies the standard CFG denoising step by introducing energy preservation. At each denoising step, it rescales the guided output xcfg by the ratio of conditional energy Ec to guided energy Ecfg, ensuring the output's energy distribution matches the conditional prediction. The method offers a robust variant that estimates energy using percentiles (typically 45th-55th) to ignore extreme pixel values and suppress confetti artifacts in monochromatic regions. The approach adds minimal computational overhead while maintaining the semantic alignment benefits of CFG.

## Key Results
- Eliminates over-contrast and over-saturation artifacts present in standard CFG at guidance levels 5-12
- Maintains natural image quality and semantic alignment across all tested guidance strengths
- Visual comparisons across 12 prompts demonstrate superior artifact suppression with minimal computational overhead

## Why This Works (Mechanism)

### Mechanism 1
- Claim: High CFG strength adds excessive energy to the conditional prediction, causing over-contrast and over-saturation artifacts.
- Mechanism: The CFG additive term (λ - 1)(xc - xu) linearly combines unconditional and conditional predictions. At high guidance strengths (7-10), this term can dramatically increase the overall energy of the guided output, pushing pixel values toward extremes.
- Core assumption: The energy increase is proportional to the guidance strength and the magnitude of the conditional prediction.
- Evidence anchors:
  - [abstract] "the CFG additive component can drastically increase the energy of the sampled latents in the progressive denoising process; the excessive energy eventually causes the over-contrast and over-saturation artifacts"
  - [section] "Eq. 1 makes it clearer to see the two components of CFG prediction xcfg: 1) conditional prediction xc; 2) CFG additive term (λ − 1)(xc − xu)"
- Break condition: If the guidance term's magnitude is inherently small relative to the conditional prediction, or if the energy distribution is already constrained by the denoising process.

### Mechanism 2
- Claim: Energy preservation through normalization at each denoising step maintains natural image quality across guidance strengths.
- Mechanism: By scaling the guided output xcfg by the ratio of conditional energy Ec to guided energy Ecfg, EP-CFG ensures that the energy distribution of the output matches the conditional prediction, preventing excessive contrast and saturation.
- Core assumption: The conditional prediction's energy distribution represents the desired output energy, and preserving this distribution prevents artifacts.
- Evidence anchors:
  - [abstract] "Our method simply rescales the energy of the guided output to match that of the conditional prediction at each denoising step"
  - [section] "x′cfg = xcfg · sEc/Ecfg, where Ec = ∥xc∥2 and Ecfg = ∥xcfg∥2"
- Break condition: If the energy ratio becomes unstable or if the conditional prediction's energy is not representative of the desired output energy.

### Mechanism 3
- Claim: Robust energy estimation by ignoring extreme pixel values suppresses confetti artifacts in monochromatic regions.
- Mechanism: By using a percentile-based approach (e.g., 45th to 55th percentile) to estimate energy, EP-CFG avoids being influenced by extreme pixel values that can cause artifacts in uniform areas.
- Core assumption: Extreme pixel values in monochromatic regions are noise artifacts rather than meaningful signal, and ignoring them improves robustness.
- Evidence anchors:
  - [abstract] "we ignore the two tails in the energy histogram and only consider a small middle region when estimating the energy terms Ec, Ecfg"
  - [section] "Erobust = Σi x²i · 1[Pl ≤ x²i ≤ Ph]"
- Break condition: If the percentile range is too narrow and excludes valid signal, or if the extreme values are meaningful for the image content.

## Foundational Learning

- Concept: Diffusion models and denoising process
  - Why needed here: EP-CFG operates within the diffusion model framework, modifying the denoising step to preserve energy distribution.
  - Quick check question: What is the role of the denoising step in diffusion models, and how does CFG modify this process?

- Concept: Energy estimation and normalization in image processing
  - Why needed here: EP-CFG relies on energy estimation (via L2 norm) and normalization to maintain consistent energy distribution across denoising steps.
  - Quick check question: How is image energy typically calculated, and what are the implications of normalizing energy in image generation?

- Concept: Percentile-based statistics and robust estimation
  - Why needed here: EP-CFG uses robust energy estimation by ignoring extreme values, which requires understanding percentile-based statistics.
  - Quick check question: How does percentile-based estimation differ from mean-based estimation, and when is it more appropriate to use?

## Architecture Onboarding

- Component map: Unconditional prediction xu -> Conditional prediction xc -> CFG additive term (λ - 1)(xc - xu) -> Guided output xcfg -> Energy scaling factor -> EP-CFG output x'cfg
- Critical path: The denoising step where EP-CFG rescales the guided output to match the conditional prediction's energy at each step
- Design tradeoffs: EP-CFG trades off some guidance strength for artifact reduction, but maintains semantic alignment benefits. The robust variant adds computational overhead but improves artifact suppression.
- Failure signatures: If the energy ratio becomes unstable, or if the conditional prediction's energy is not representative of the desired output energy, artifacts may persist or worsen.
- First 3 experiments:
  1. Compare EP-CFG with standard CFG at different guidance strengths (5, 7, 9, 12) on a simple prompt to observe artifact reduction.
  2. Test the robust energy estimation variant by comparing results with and without it on prompts with monochromatic regions.
  3. Measure the computational overhead of EP-CFG by comparing inference times with standard CFG.

## Open Questions the Paper Calls Out

### Open Question 1
- Question: How does EP-CFG's robust energy estimation (using percentiles 45-55) compare to other percentile ranges or alternative outlier-robust methods in terms of artifact suppression and visual quality?
- Basis in paper: [explicit] The paper states they recommend using l=45, h=55 based on empirical findings but does not explore other percentile ranges or compare with alternative robust estimation methods.
- Why unresolved: The paper only tests one specific percentile configuration without exploring the sensitivity of results to different percentile thresholds or comparing with other robust statistics like median absolute deviation.
- What evidence would resolve it: Systematic experiments varying percentile thresholds (e.g., 40-60, 30-70, 25-75) and comparing against other robust statistics would reveal optimal configurations and whether the 45-55 choice is genuinely optimal.

### Open Question 2
- Question: What is the quantitative impact of EP-CFG on perceptual metrics like FID, CLIP score, or human preference studies compared to standard CFG and APG?
- Basis in paper: [inferred] The paper presents only qualitative visual comparisons without reporting any quantitative metrics, making it impossible to objectively measure the improvement in image quality or semantic alignment.
- Why unresolved: The absence of quantitative evaluation means there's no objective measurement of whether EP-CFG's improvements are statistically significant or how it compares to concurrent methods like APG.
- What evidence would resolve it: Computing and reporting FID scores, CLIP similarity scores, and conducting human preference studies across multiple guidance strengths would provide objective evidence of EP-CFG's effectiveness.

### Open Question 3
- Question: How does EP-CFG perform on non-photorealistic generation tasks like abstract art, pixel art, or highly stylized imagery where energy distribution characteristics differ from natural images?
- Basis in paper: [inferred] All presented examples are photorealistic or representational art styles, with no exploration of EP-CFG's behavior on non-natural image distributions or highly stylized content.
- Why unresolved: The paper does not investigate whether the energy preservation approach generalizes to domains where the energy distribution of conditional predictions may not follow the same patterns as natural photographs.
- What evidence would resolve it: Testing EP-CFG on diverse artistic styles, abstract generation tasks, and low-resolution pixel art would reveal whether the method's assumptions about energy distribution hold across different visual domains.

## Limitations
- The paper relies entirely on visual comparisons without quantitative metrics to support claims about artifact reduction and image quality preservation
- No evidence is provided that EP-CFG maintains the semantic alignment benefits of CFG while reducing artifacts
- The method has only been tested on photorealistic and representational art styles, with no exploration of non-natural image distributions

## Confidence

- **High Confidence**: The mechanism of energy preservation through normalization is mathematically sound and well-specified
- **Medium Confidence**: The claim that over-contrast and over-saturation are caused by excessive energy in CFG, based on the described additive mechanism
- **Low Confidence**: The assertion that EP-CFG maintains "natural image quality" and "semantic alignment benefits" without quantitative evidence

## Next Checks
1. Implement quantitative metrics (e.g., FID, LPIPS, saturation histograms) to measure actual artifact reduction and image quality changes when comparing EP-CFG to standard CFG across multiple guidance strengths
2. Conduct ablation studies to determine whether the energy preservation mechanism or the robust estimation variant contributes more to artifact reduction
3. Test EP-CFG on a wider variety of prompts and image types (including those with high dynamic range content) to verify that energy preservation doesn't degrade semantic alignment or introduce new artifacts