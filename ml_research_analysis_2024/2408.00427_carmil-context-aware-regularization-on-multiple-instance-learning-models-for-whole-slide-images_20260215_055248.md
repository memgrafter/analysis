---
ver: rpa2
title: 'CARMIL: Context-Aware Regularization on Multiple Instance Learning models
  for Whole Slide Images'
arxiv_id: '2408.00427'
source_url: https://arxiv.org/abs/2408.00427
tags:
- spatial
- tiles
- carmil
- tcga
- matrix
- transformers
- self-attention
- retrieval-augmented-generation
- instruction-tuning
- parameter-efficient-finetuning
- mixture-of-experts
- chain-of-thought
core_contribution: CARMIL introduces Context-Aware Regularization for Multiple Instance
  Learning (MIL) models applied to Whole Slide Images (WSIs). The method addresses
  the limitation of standard MIL models that assume independence between patches,
  ignoring spatial context important for tumor diagnosis.
---

# CARMIL: Context-Aware Regularization on Multiple Instance Learning models for Whole Slide Images

## Quick Facts
- arXiv ID: 2408.00427
- Source URL: https://arxiv.org/abs/2408.00427
- Reference count: 20
- CARMIL improves C-index by up to 4.8 percentage points on survival prediction tasks

## Executive Summary
CARMIL addresses the limitation of standard Multiple Instance Learning (MIL) models that assume independence between patches in Whole Slide Images (WSIs), ignoring spatial context important for tumor diagnosis. The method introduces a spatial encoder and decoder that use regularization to encourage reconstruction of the input graph of patches based on spatial proximity. This approach integrates spatial information into tile embeddings without requiring complex graph architectures. On survival prediction tasks for glioblastoma and colon cancer, CARMIL achieves performance comparable to state-of-the-art spatial methods while maintaining flexibility and generalizability across different MIL models.

## Method Summary
CARMIL enhances any MIL model by adding a spatial encoder and decoder that process the graph structure of WSI tiles. The spatial encoder transforms tile features into embeddings that preserve spatial relationships, while the spatial decoder attempts to reconstruct the adjacency matrix from these embeddings. A novel DeltaCon metric quantifies Context-Awareness by measuring similarity between spatial and embedding-based adjacency matrices. The model is trained with a joint loss combining the standard MIL survival prediction loss and the Context-Aware Regularization loss that encourages spatial structure preservation in the embeddings.

## Key Results
- CARMIL improves C-index by up to 4.8 percentage points compared to baseline MIL models on TCGA GBM and TCAD datasets
- Achieves performance comparable to state-of-the-art spatial methods while being more flexible and generalizable
- Demonstrates significant improvement over context-agnostic MIL models through ablation studies and shuffling experiments

## Why This Works (Mechanism)

### Mechanism 1
- Claim: CARMIL successfully integrates spatial context into tile embeddings by training a spatial decoder to reconstruct the graph of tiles based on spatial proximity.
- Mechanism: The spatial encoder learns to map tiles into a lower-dimensional space where tiles that are close in the original WSI are also close in the embedding space. The spatial decoder then attempts to reconstruct the adjacency matrix based on these embeddings, encouraging the encoder to preserve spatial relationships.
- Core assumption: The spatial decoder can effectively reconstruct the graph structure from the embeddings, and the regularization term balances spatial context preservation with the primary MIL task.
- Evidence anchors:
  - [abstract] "CARMIL adds a spatial encoder and decoder to any MIL model, using regularization to encourage the spatial decoder to reconstruct the input graph of patches based on their spatial proximity."
  - [section 2.2] "To embed the spatial structure of the WSI into the tiles features, we introduce a spatial encoder fE of parameters θE and a spatial decoder fD of parameters θD before the classical MIL model fMIL...the goal of fE is to distill the spatial relation between neighboring tiles directly into the tile embeddings so that any MIL model can exploit this information."
- Break condition: If the spatial decoder cannot accurately reconstruct the adjacency matrix, the spatial context information in the embeddings would be insufficient, leading to minimal performance improvement over baseline MIL models.

### Mechanism 2
- Claim: The DeltaCon metric effectively quantifies the amount of spatial context preserved in tile embeddings by comparing the similarity between adjacency matrices based on spatial coordinates and embedding space.
- Mechanism: DeltaCon computes a similarity score between two graphs by measuring how well the adjacency matrix in the embedding space (where edges represent proximity in embedding space) matches the adjacency matrix based on spatial coordinates (where edges represent actual spatial proximity in the WSI).
- Core assumption: DeltaCon can meaningfully capture the degree to which embeddings preserve spatial relationships, and higher DeltaCon scores correlate with better preservation of spatial context.
- Evidence anchors:
  - [section 2.3] "We propose to use the DeltaCon similarity between the adjacency matrix based on tiles descriptors A( ˆZ) and the adjacency matrix based on the spatial coordinates A for the same WSI as our metric of Context-Awareness."
  - [section 4.2] "A higher DeltaCon score indicates a higher degree of spatial consistency in the learnt embedding space as it implies that the arrangement in the embedding space closely aligns with the original spatial organization within the slide."
- Break condition: If DeltaCon scores do not correlate with improved downstream task performance (e.g., C-index), then the metric may not effectively capture the relevant aspects of spatial context preservation.

### Mechanism 3
- Claim: CARMIL achieves performance comparable to state-of-the-art spatial methods without requiring complex graph architectures by using regularization instead of parameterized spatial models.
- Mechanism: By adding spatial encoder and decoder modules with regularization rather than modifying the MIL model architecture itself, CARMIL introduces spatial context awareness while maintaining the flexibility and generalizability of standard MIL models.
- Core assumption: Regularization can effectively encode spatial relationships without the need for complex parameterized spatial models, and this approach is more data-efficient than architectures with many spatial parameters.
- Evidence anchors:
  - [abstract] "CARMIL improves C-index by up to 4.8 percentage points compared to baseline MIL models, achieving performance comparable to state-of-the-art spatial methods while being more flexible and generalizable."
  - [section 2.2] "Incorporating spatial correlations between tiles into the model through regularization has been under-explored in computational pathology...we introduce the CARMIL framework to enhance the Context-Awareness of any MIL model, initially agnostic to the spatial context, using Regularization."
- Break condition: If CARMIL performance degrades significantly when training data is limited, it would suggest that the regularization approach requires substantial data to learn effective spatial encoding.

## Foundational Learning

- Concept: Graph Neural Networks (GNNs) and their ability to process graph-structured data.
  - Why needed here: CARMIL uses GCN layers in both the spatial encoder and decoder to process the graph of tiles, requiring understanding of how GNNs propagate and transform information through graph structures.
  - Quick check question: How do GCN layers aggregate information from neighboring nodes, and what role does the adjacency matrix play in this process?

- Concept: Multiple Instance Learning (MIL) and its assumption of instance independence.
  - Why needed here: CARMIL builds upon standard MIL frameworks but addresses their limitation of assuming tile independence, so understanding this foundational concept is crucial for grasping the motivation and approach.
  - Quick check question: What is the key limitation of standard MIL when applied to WSIs, and how does CARMIL address this limitation?

- Concept: Regularization techniques and their role in deep learning.
  - Why needed here: CARMIL introduces a novel regularization term that encourages the spatial decoder to reconstruct the graph structure, requiring understanding of how regularization can shape learned representations without modifying model architecture.
  - Quick check question: How does adding a regularization term to the loss function influence the learned representations, and what are the tradeoffs of using regularization versus architectural modifications?

## Architecture Onboarding

- Component map: Pre-trained feature extractor → tile features X → spatial encoder (GCN) → context-aware embeddings Z → spatial decoder (GCN + inner product) → reconstructed adjacency matrix and MIL model → survival risk prediction

- Critical path: X → fE → Z → fD → ˆA (reconstruction) and Z → fMIL → risk prediction

- Design tradeoffs:
  - Flexibility vs. complexity: CARMIL can be added to any MIL model but introduces additional components (spatial encoder/decoder) that increase model complexity
  - Spatial context vs. task performance: The regularization weight β must balance spatial context preservation with primary task performance
  - Computational cost: Additional GCN layers and reconstruction loss increase training time and memory requirements

- Failure signatures:
  - Minimal performance improvement over baseline MIL: suggests spatial context is not effectively encoded in embeddings
  - High reconstruction loss but no performance gain: indicates spatial information is encoded but not useful for the downstream task
  - Performance degradation when shuffling graph: confirms model is using graph structure, but excessive degradation suggests over-reliance on specific graph patterns
  - Low DeltaCon scores: indicates embeddings do not preserve spatial relationships effectively

- First 3 experiments:
  1. Verify spatial decoder reconstruction: Train CARMIL with β=1 (only reconstruction loss) and measure adjacency matrix reconstruction accuracy to confirm the spatial decoder can learn meaningful graph structure
  2. Ablation study on regularization weight: Train CARMIL with different β values (0, 0.5, 1) to find the optimal balance between spatial context preservation and task performance
  3. DeltaCon correlation analysis: Compute DeltaCon scores for learned embeddings and correlate with downstream task performance (C-index) to validate the metric's effectiveness in quantifying spatial context awareness

## Open Questions the Paper Calls Out

### Open Question 1
- Question: How does the choice of k (number of nearest neighbors) affect the DeltaCon metric and model performance across different WSI sizes?
- Basis in paper: [inferred] The paper mentions that k is optimized across a fixed grid of values, independent of the number of tiles n, which varies with WSI size.
- Why unresolved: The paper does not investigate the relationship between k and n, or how k should scale with WSI size to optimize spatial context incorporation.
- What evidence would resolve it: Empirical studies varying k proportionally to n across WSIs of different sizes, measuring DeltaCon scores and C-index performance to find an optimal scaling relationship.

### Open Question 2
- Question: What is the relationship between Context-Awareness (DeltaCon score) and model robustness to perturbations in the input graph structure?
- Basis in paper: [inferred] The paper shows that shuffling the adjacency matrix degrades performance, suggesting the graph structure is important, but does not directly measure robustness.
- Why unresolved: While the paper demonstrates that spatial context is used, it does not quantify how robust CARMIL models are to various types of graph perturbations compared to context-agnostic models.
- What evidence would resolve it: Systematic perturbation studies (random shuffling, node/edge removal, adversarial attacks) on CARMIL and baseline models, measuring performance degradation and DeltaCon changes.

### Open Question 3
- Question: How does the choice of feature extractor architecture and training method impact the effectiveness of CARMIL's spatial regularization?
- Basis in paper: [explicit] The paper states "we did not investigate the impact of the feature extractor on overall performance" and uses a frozen pre-trained model.
- Why unresolved: The paper uses a fixed feature extractor (Phikon) and does not explore how different feature extractors or training strategies might affect CARMIL's ability to incorporate spatial context.
- What evidence would resolve it: Experiments comparing CARMIL with different feature extractors (trained from scratch, fine-tuned, different architectures) while keeping CARMIL components constant, measuring DeltaCon and C-index performance.

### Open Question 4
- Question: Can CARMIL's regularization approach be extended to capture higher-order spatial relationships beyond immediate neighbors?
- Basis in paper: [inferred] CARMIL uses k-nearest neighbors for graph construction, which captures local spatial context, but the paper does not explore extending this to longer-range spatial dependencies.
- Why unresolved: The current approach focuses on local spatial relationships through nearest neighbor graphs, but does not investigate whether incorporating longer-range spatial dependencies could further improve performance.
- What evidence would resolve it: Experiments with CARMIL variants using different graph constructions (e.g., multi-scale graphs, path-based graphs, attention over larger neighborhoods) and measuring the impact on DeltaCon scores and survival prediction performance.

## Limitations
- Limited generalizability beyond two cancer types (GBM and COAD) tested in the study
- Optimal regularization weight β determined empirically may not be universally applicable
- Computational overhead from additional GCN layers may be prohibitive for very large WSIs

## Confidence
- High confidence in effectiveness of CARMIL in improving C-index (4.8 pp gain demonstrated)
- Medium confidence in DeltaCon metric's correlation with spatial context preservation (validated internally but not externally)
- Medium confidence in generalizability claim (supported by ablation studies on different MIL models but limited to two cancer types)

## Next Checks
1. Evaluate CARMIL on an independent WSI dataset from a different cancer type to assess cross-domain generalizability
2. Conduct systematic ablation studies varying β across a wider range to determine sensitivity to this critical hyperparameter
3. Compare CARMIL's computational efficiency against state-of-the-art spatial MIL methods using wall-clock training time and memory usage metrics