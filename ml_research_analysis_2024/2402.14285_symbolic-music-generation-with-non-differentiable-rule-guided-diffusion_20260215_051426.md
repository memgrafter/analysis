---
ver: rpa2
title: Symbolic Music Generation with Non-Differentiable Rule Guided Diffusion
arxiv_id: '2402.14285'
source_url: https://arxiv.org/abs/2402.14285
tags:
- music
- rule
- diffusion
- guidance
- generation
- transformers
- self-attention
- retrieval-augmented-generation
- instruction-tuning
- parameter-efficient-finetuning
- mixture-of-experts
- chain-of-thought
core_contribution: This paper tackles the problem of generating symbolic music (e.g.,
  piano rolls) with non-differentiable rule guidance. The authors propose Stochastic
  Control Guidance (SCG), a novel method that enables plug-and-play guidance in diffusion
  models for non-differentiable rules by sampling multiple realizations and selecting
  the one yielding the most rule-compliant clean sample.
---

# Symbolic Music Generation with Non-Differentiable Rule Guided Diffusion

## Quick Facts
- arXiv ID: 2402.14285
- Source URL: https://arxiv.org/abs/2402.14285
- Reference count: 40
- One-line primary result: Achieves highest average overlapping area (OA) across seven music attributes compared to strong baselines like MusicTr, Remi, CPW, and PolyDiff

## Executive Summary
This paper introduces Stochastic Control Guidance (SCG), a novel method for guiding diffusion models with non-differentiable rules in symbolic music generation. The key innovation is enabling plug-and-play guidance without requiring gradient-based rule functions, making it applicable to black-box APIs and complex constraints. The authors demonstrate superior performance in generating piano music that adheres to various musical attributes while maintaining high generation quality. Their latent diffusion architecture with 10ms time resolution captures nuanced musical expressions effectively.

## Method Summary
The proposed method combines a latent diffusion architecture with Stochastic Control Guidance (SCG) for non-differentiable rule guidance. First, a VAE encodes piano roll segments into a lower-dimensional latent space. A diffusion model is then trained on these latent representations. During sampling, SCG generates multiple candidate next steps at each diffusion timestep, estimates the corresponding clean samples, and selects the candidate that minimizes the rule loss. This process only requires forward evaluation of rule functions, making it applicable to non-differentiable rules. The method is compatible with various sampling procedures including DDPM and DDIM, and can be applied to editing tasks.

## Key Results
- Achieves highest average overlapping area (OA) across seven music attributes on all tested datasets compared to baselines
- Outperforms popular methods like MusicTr, Remi, CPW, and PolyDiff in rule alignment while maintaining music quality
- Demonstrates effective controllability in music editing tasks including note density and chord progression editing

## Why This Works (Mechanism)

### Mechanism 1
SCG achieves plug-and-play guidance for non-differentiable rules by sampling multiple realizations and selecting the one yielding the most rule-compliant clean sample. At each sampling step, SCG generates multiple candidate next steps from the current state, estimates the corresponding clean samples for each candidate, and selects the candidate that minimizes the rule loss. This process only requires forward evaluation of the rule function, making it applicable to non-differentiable rules.

### Mechanism 2
SCG can be viewed through the lens of stochastic optimal control, where the problem of generating samples that follow rule guidance is posed as an optimal control problem within a stochastic dynamical system. The authors formulate the problem using stochastic optimal control theory, deriving an analytical form of optimal control via path integral control theory. They show that the desirability function (inverse of the value function) equals the likelihood function, enabling many guidance methods to be viewed as different implementations of optimal control.

### Mechanism 3
SCG is compatible with various sampling procedures in diffusion models, including DDPM, DDIM, and editing tasks. The key of SCG is to sample multiple xt−1 given xt and select the one that leads to the sample that follows the rule best. This process can be integrated with different sampling algorithms by modifying how xt−1 is sampled given xt.

## Foundational Learning

- Concept: Stochastic differential equations (SDEs)
  - Why needed here: The diffusion process in diffusion models is modeled as an SDE, and the reverse-time SDE is used for sampling. Understanding SDEs is crucial for grasping the theoretical foundations of SCG.
  - Quick check question: What is the difference between the forward diffusion SDE and the reverse-time SDE in diffusion models?

- Concept: Path integral control theory
  - Why needed here: SCG draws inspiration from path integral control theory to derive the optimal control policy for guiding diffusion models with non-differentiable rules.
  - Quick check question: How does path integral control theory relate to the problem of finding the optimal control policy in SCG?

- Concept: Latent diffusion models
  - Why needed here: The paper introduces a latent diffusion architecture for symbolic music generation with high time resolution, which can be composed with SCG in a plug-and-play fashion.
  - Quick check question: What are the advantages of using a latent diffusion model over a standard pixel-space diffusion model for symbolic music generation?

## Architecture Onboarding

- Component map: VAE -> Diffusion model -> SCG guidance -> Decoder
- Critical path:
  1. Encode piano roll segments to latent space using VAE
  2. Train diffusion model on latent space
  3. During sampling, apply SCG to guide the generation process based on non-differentiable rules
  4. Decode latent representation back to piano roll
- Design tradeoffs:
  - Higher time resolution (10ms) allows for more dynamic performances but increases computational cost
  - Using a latent space reduces the dimensionality of the data, making it more efficient to train diffusion models
  - SCG trades computational cost (multiple samples per step) for the ability to handle non-differentiable rules
- Failure signatures:
  - If the VAE reconstruction is poor, the generated music may not accurately represent the intended performance
  - If the diffusion model is not well-trained, the generated music may lack diversity or quality
  - If the SCG selection process is not effective, the generated music may not adhere to the specified rules
- First 3 experiments:
  1. Train the VAE on a small subset of the piano roll data and evaluate the reconstruction quality
  2. Train the diffusion model on the latent space and assess the unconditional generation quality
  3. Implement SCG with a simple non-differentiable rule (e.g., note density) and evaluate the guided generation performance

## Open Questions the Paper Calls Out

### Open Question 1
- Question: What is the optimal number of samples (n) to use at each step in Stochastic Control Guidance (SCG) to balance rule adherence and computational efficiency?
- Basis in paper: Explicit - Table 5 shows results for different values of n (4, 8, 16)
- Why unresolved: The paper shows a trade-off between rule adherence and computational time, but doesn't provide a definitive recommendation for the optimal n.
- What evidence would resolve it: A systematic study varying n across multiple tasks and datasets, with a clear evaluation of the trade-off between rule adherence and computational efficiency.

### Open Question 2
- Question: How does the performance of SCG compare to other guidance methods when the rule functions are black-box APIs?
- Basis in paper: Explicit - The paper claims SCG can handle black-box APIs, but doesn't provide a direct comparison with other methods in this scenario.
- Why unresolved: The paper doesn't provide empirical evidence comparing SCG's performance with other methods when rule functions are black-box APIs.
- What evidence would resolve it: A controlled experiment where rule functions are replaced with black-box APIs, and the performance of SCG and other methods is compared.

### Open Question 3
- Question: What is the impact of the noise level in the SDEdit framework on the quality and controllability of the generated music?
- Basis in paper: Explicit - The paper mentions using different noise levels for note density and chord progression editing, but doesn't provide a comprehensive analysis.
- Why unresolved: The paper doesn't explore the full range of noise levels or their impact on the generated music's quality and controllability.
- What evidence would resolve it: A systematic study varying the noise level across a wide range, with a clear evaluation of its impact on the generated music's quality and controllability.

## Limitations
- The SCG method's reliance on multiple sampling per step introduces significant computational overhead, particularly for complex rule functions or high-dimensional latent spaces
- The latent diffusion architecture requires careful hyperparameter tuning for the VAE and diffusion model components, with limited ablation studies on architectural choices
- Performance degradation for increasingly complex rule functions hasn't been thoroughly characterized

## Confidence
- **High Confidence**: The core SCG algorithm and its theoretical foundations in stochastic optimal control are well-established and clearly explained
- **Medium Confidence**: The claim of state-of-the-art performance is supported by objective metrics, but the comparison with other methods could be more comprehensive
- **Low Confidence**: The scalability analysis and computational cost implications across different rule complexities and latent space sizes are not thoroughly explored

## Next Checks
1. **Computational Efficiency Analysis**: Systematically measure the computational cost (runtime and memory usage) of SCG with varying numbers of samples per step (1-10) across different rule complexities and latent space sizes to establish practical limits and optimization guidelines

2. **Rule Function Robustness Test**: Evaluate SCG's performance with increasingly complex non-differentiable rules (e.g., combining multiple rules, introducing stochastic elements) to identify failure modes and establish boundaries for rule complexity

3. **Architecture Ablation Study**: Conduct controlled experiments varying the latent space dimensionality, number of VAE downsampling layers, and diffusion model architecture to identify optimal configurations for different musical styles and rule sets