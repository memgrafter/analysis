---
ver: rpa2
title: Solving Inverse Problems via Diffusion Optimal Control
arxiv_id: '2412.16748'
source_url: https://arxiv.org/abs/2412.16748
tags:
- diffusion
- control
- inverse
- optimal
- arxiv
- transformers
- self-attention
- retrieval-augmented-generation
- instruction-tuning
- parameter-efficient-finetuning
- mixture-of-experts
- chain-of-thought
core_contribution: This work reframes the reverse diffusion process as an optimal
  control problem, leveraging the iterative Linear Quadratic Regulator (iLQR) algorithm
  to guide the sampling trajectory. By injecting control directly into the diffusion
  dynamics, the method bypasses the need for approximate conditional score functions
  and avoids dependence on the final reconstruction accuracy.
---

# Solving Inverse Problems via Diffusion Optimal Control

## Quick Facts
- arXiv ID: 2412.16748
- Source URL: https://arxiv.org/abs/2412.16748
- Authors: Henry Li; Marcus Pereira
- Reference count: 40
- This work reframes the reverse diffusion process as an optimal control problem, leveraging the iterative Linear Quadratic Regulator (iLQR) algorithm to guide the sampling trajectory. By injecting control directly into the diffusion dynamics, the method bypasses the need for approximate conditional score functions and avoids dependence on the final reconstruction accuracy. The framework is fully general, handling arbitrary differentiable forward operators such as super-resolution, inpainting, deblurring, and nonlinear classification. Theoretical analysis shows that the idealized posterior sampling equation can be recovered as a special case under mild conditions. Empirically, the approach achieves state-of-the-art FID and LPIPS scores on FFHQ 256x256 across multiple inverse problems, with robust performance even under discretization and low-rank approximations.

## Executive Summary
This paper introduces a novel framework for solving inverse problems by reformulating the reverse diffusion process as an optimal control problem. The method leverages the iterative Linear Quadratic Regulator (iLQR) algorithm to inject control actions directly into the diffusion dynamics, bypassing the need for approximate conditional score functions that depend on noisy diffusion variates. This approach achieves state-of-the-art reconstruction quality across multiple inverse problems including super-resolution, inpainting, and deblurring, while demonstrating robustness to discretization errors and low-rank approximations. The framework provides a principled way to solve inverse problems without requiring retraining or modification of existing diffusion models.

## Method Summary
The proposed method reframes the reverse diffusion process as an optimal control problem where the state is the evolving signal x_t and the control actions u_t guide the trajectory toward solutions consistent with measurements y. The approach uses iLQR to compute optimal control actions by minimizing a cost function that balances reconstruction quality with control effort. The method can operate in input or output perturbation modes and incorporates low-rank approximations and matrix-free evaluations for computational efficiency. Critically, the framework avoids the need for conditional score functions by directly optimizing the trajectory to minimize measurement error, while still recovering the idealized posterior sampling equation as a special case under specific conditions.

## Key Results
- Achieves state-of-the-art FID and LPIPS scores on FFHQ 256x256 across multiple inverse problems
- Demonstrates robustness to discretization errors and low-rank approximations
- Successfully handles arbitrary differentiable forward operators including super-resolution, inpainting, and deblurring
- Recovers idealized posterior sampling equation as special case of optimal control framework

## Why This Works (Mechanism)

### Mechanism 1
- Claim: The proposed framework avoids the intractability of conditional score functions by reformulating the diffusion process as an optimal control problem.
- Mechanism: By injecting control vectors directly into the reverse diffusion dynamics, the method bypasses the need for approximate conditional score functions that depend on the noisy diffusion variate xt rather than the final sample x0. The control-guided trajectory can compute x0 exactly at each step, enabling direct computation of the true conditional score.
- Core assumption: The forward operator A is differentiable and the noise in measurements follows a known distribution (typically Gaussian).
- Evidence anchors:
  - [abstract] "We demonstrate that these limitations can be sidestepped by reframing the generative process as a discrete optimal control episode."
  - [section 2.3] "Optimal control is the structured and principled approach to the guidance of dynamical systems over time."
  - [corpus] Found 25 related papers with average FMR=0.429, but no direct evidence about bypassing conditional score functions specifically
- Break condition: If the forward operator A is non-differentiable or the measurement noise distribution is unknown, the framework cannot compute the necessary gradients.

### Mechanism 2
- Claim: The idealized posterior sampling equation can be recovered exactly as a special case of the optimal control algorithm under mild conditions.
- Mechanism: When the terminal cost is set to the negative log-likelihood of the measurement given x0, and running costs are zero, the iLQR algorithm produces controls that coincide precisely with the desired conditional scores ∇xt log p(y|x0). This effectively recovers the posterior sampling equation without approximations.
- Core assumption: The diffusion model's score network approximates the true data score function ∇xt log pt(xt).
- Evidence anchors:
  - [section 4] "we show that the idealized posterior sampling score Song et al. [2021] — approximated by existing methods — can be recovered exactly as a specific case of our method."
  - [section 4] "Theorem 4.1... the iterative linear quadratic regulator with Tikhonov regularizer α produces the control ut = α∇xt log p(y|x0)"
  - [corpus] No direct evidence about recovering posterior sampling as special case found in corpus
- Break condition: If the score network poorly approximates the true data score, the recovered posterior sampling may be inaccurate.

### Mechanism 3
- Claim: The method achieves robustness to approximation quality of the score function, unlike probabilistic samplers that fail when approximations are poor.
- Mechanism: Since the optimal control framework treats the problem as an optimization over dynamical systems rather than sampling from a posterior, it can produce reasonable solutions even when the learned score function is inaccurate. The method directly optimizes for measurement consistency rather than relying on accurate conditional score approximations.
- Core assumption: The unconditional diffusion process provides a reasonable prior that can be guided toward solutions even with imperfect score approximations.
- Evidence anchors:
  - [section 4] "we emphasize that the performance of our method does not necessitate this condition. In fact, we find that reconstruction performance is theoretically and empirically robust to the accuracy of the approximated prior score"
  - [section 4] "we demonstrate that our sampler produces remarkably reasonable solutions even in the case of randomly initialized diffusion models"
  - [corpus] No direct evidence about robustness to score approximation quality found in corpus
- Break condition: If the unconditional diffusion prior is completely uninformative (e.g., randomly initialized model), the method may still produce poor reconstructions.

## Foundational Learning

- Concept: Diffusion models and score-based generative modeling
  - Why needed here: The method builds directly on diffusion models as the underlying generative process that is then controlled
  - Quick check question: What is the relationship between the reverse-time SDE in diffusion models and the corresponding probability-flow ODE?

- Concept: Optimal control theory and the iterative Linear Quadratic Regulator (iLQR)
  - Why needed here: The framework reformulates the diffusion process as an optimal control problem and uses iLQR for trajectory optimization
  - Quick check question: How does the value function V(xt,t) relate to the state-action value function Q(xt,ut) in the iLQR algorithm?

- Concept: Inverse problems and Bayesian inference
  - Why needed here: The method solves inverse problems by finding signals that are consistent with both the prior (from diffusion) and the measurements
  - Quick check question: How does the measurement model y = A(x0) + η define the posterior distribution p(x|y) that the method aims to approximate?

## Architecture Onboarding

- Component map:
  Pre-trained unconditional diffusion model -> Forward operator A -> iLQR controller -> Control injection mechanism -> Measurement likelihood computation

- Critical path:
  1. Initialize with uncontrolled diffusion trajectory
  2. Compute derivatives of value function using measurement likelihood
  3. Calculate feedforward and feedback gains via iLQR
  4. Update control actions and propagate state forward
  5. Repeat until convergence or max iterations

- Design tradeoffs:
  - Input vs output perturbation control: Input perturbation is more stable but requires careful handling of state updates
  - Tikhonov regularization: Balances numerical stability vs control accuracy
  - Low-rank approximation rank: Tradeoff between computational efficiency and control precision

- Failure signatures:
  - Poor reconstruction quality despite convergence: Indicates inaccurate score network or inappropriate control gains
  - Numerical instability during matrix inversions: Suggests need for stronger Tikhonov regularization
  - Slow convergence: May indicate suboptimal rank for low-rank approximations

- First 3 experiments:
  1. Super-resolution task with bicubic downsampling on FFHQ dataset
  2. Random inpainting task with 92% pixel removal on FFHQ dataset
  3. Gaussian deblurring task with 61×61 kernel on FFHQ dataset

## Open Questions the Paper Calls Out

### Open Question 1
- Question: Can the diffusion optimal control framework be extended to handle multimodal posteriors where the conditional distribution p(x|y) has multiple distinct modes?
- Basis in paper: [inferred] The paper discusses handling arbitrary differentiable forward operators and achieving high-quality reconstructions across various inverse problems. However, it does not explicitly address cases where the posterior distribution is multimodal.
- Why unresolved: Multimodal posteriors present unique challenges in sampling and reconstruction that may require specialized control strategies beyond the current iLQR-based approach.
- What evidence would resolve it: Experimental results demonstrating successful reconstruction of images from multimodal inverse problems (e.g., phase retrieval with multiple possible solutions) would show the framework's capability to handle such cases.

### Open Question 2
- Question: How does the performance of diffusion optimal control scale with increasing problem dimensionality, particularly for high-resolution image reconstruction beyond 256x256?
- Basis in paper: [explicit] The paper discusses computational complexity analysis and high-dimensional control challenges, noting that matrices contain approximately 39B parameters for 256x256 images. It proposes modifications like low-rank approximations and matrix-free evaluations.
- Why unresolved: While the paper provides theoretical complexity analysis and some practical optimizations, it doesn't present empirical results for significantly higher dimensional problems or establish clear scaling limits.
- What evidence would resolve it: Systematic experiments comparing reconstruction quality and computational requirements across increasing image resolutions (e.g., 512x512, 1024x1024) would demonstrate the practical scaling behavior.

### Open Question 3
- Question: What is the theoretical relationship between the Tikhonov regularization parameter α and the quality of posterior sampling in the deterministic case?
- Basis in paper: [explicit] Lemma 4.2 states that α = 1/(g(t)^2 * Δt) recovers posterior sampling in the deterministic case, but doesn't explore the effects of other α values on sampling quality.
- Why unresolved: The paper establishes one specific value of α that recovers the ideal sampler but doesn't investigate the broader relationship between α and sampling performance, particularly for values that deviate from this ideal.
- What evidence would resolve it: A comprehensive study showing reconstruction quality (e.g., FID, LPIPS) across a range of α values for various inverse problems would clarify the impact of regularization strength on sampling performance.

## Limitations

- Computational cost scales with trajectory length and may be prohibitive for high-resolution applications
- Performance depends heavily on the quality of the unconditional diffusion model
- Theoretical analysis assumes idealized conditions that may not translate to practical settings

## Confidence

- High confidence in the core optimal control reformulation and iLQR implementation
- Medium confidence in the theoretical recovery of posterior sampling equation
- Medium confidence in robustness claims to score approximation quality
- Low confidence in scalability to very high-resolution images given computational requirements

## Next Checks

1. Test the method's performance with different diffusion model architectures (e.g., DDPM, DDIM) to assess architectural sensitivity
2. Evaluate reconstruction quality under varying noise levels in measurements to quantify robustness bounds
3. Compare computational efficiency against probabilistic samplers across different trajectory lengths and discretization levels