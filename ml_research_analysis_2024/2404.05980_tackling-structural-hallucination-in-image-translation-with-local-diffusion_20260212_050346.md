---
ver: rpa2
title: Tackling Structural Hallucination in Image Translation with Local Diffusion
arxiv_id: '2404.05980'
source_url: https://arxiv.org/abs/2404.05980
tags:
- image
- diffusion
- ddpm
- hallucination
- elbo
- transformers
- self-attention
- retrieval-augmented-generation
- instruction-tuning
- parameter-efficient-finetuning
- mixture-of-experts
- chain-of-thought
core_contribution: This paper addresses the problem of "structural hallucination"
  in conditional diffusion models, where models generate realistic-looking but inaccurate
  reconstructions when processing out-of-distribution (OOD) data, such as tumors in
  medical images. The core method idea is to partition the OOD regions in conditional
  images and perform separate local diffusion processes for in-distribution (IND)
  and OOD regions, followed by a fusion module to integrate the predictions.
---

# Tackling Structural Hallucination in Image Translation with Local Diffusion

## Quick Facts
- arXiv ID: 2404.05980
- Source URL: https://arxiv.org/abs/2404.05980
- Reference count: 40
- Primary result: Reduces misdiagnosis by 40% in medical lesion segmentation and 25% in natural image anomaly detection tasks

## Executive Summary
This paper addresses the problem of "structural hallucination" in conditional diffusion models, where models generate realistic-looking but inaccurate reconstructions when processing out-of-distribution (OOD) data, such as tumors in medical images. The core method partitions OOD regions in conditional images and performs separate local diffusion processes for in-distribution (IND) and OOD regions, followed by a fusion module to integrate the predictions. This approach significantly reduces misdiagnosis in medical lesion segmentation and natural image anomaly detection tasks without requiring fine-tuning of the pre-trained diffusion model.

## Method Summary
The method tackles structural hallucination by partitioning conditional images into OOD and IND regions, then performing separate local diffusion processes for each region. The approach uses PatchCore for OOD detection, branches into parallel local diffusion for OOD and IND regions, and employs a fusion module to merge predictions. The method is evaluated on MNIST, BraTS, and MVTec AD datasets for tasks including 2x super-resolution, image translation, and anomaly detection, using metrics like PSNR, SSIM, classification accuracy, and dice coefficient.

## Key Results
- Reduces misdiagnosis by 40% in medical lesion segmentation tasks
- Achieves 25% improvement in natural image anomaly detection
- Demonstrates compatibility with various pre-trained diffusion models without requiring fine-tuning

## Why This Works (Mechanism)

### Mechanism 1
- Claim: Local OOD/IND region partitioning reduces structural hallucination by focusing the diffusion model on regionally coherent statistics.
- Mechanism: Partitioning the conditional image into OOD and IND regions, then performing separate local diffusion processes allows each process to denoise using only data from its local distribution. This prevents cross-region interference where IND denoising incorrectly adapts to OOD patterns.
- Core assumption: The OOD region can be accurately detected and segmented such that the local statistics remain coherent within each partition.
- Evidence anchors:
  - [abstract] "We verify that partitioning the OOD region and conducting separate image generations alleviates hallucinations in several applications."
  - [section 3.3] "By focusing on each region independently, we demonstrated that our segmentation strategy effectively reduces such artefacts."
  - [corpus] Weak: No corpus papers directly address this exact mechanism, though similar concepts appear in segmentation-based anomaly detection.
- Break condition: OOD detection fails to segment regions cleanly, causing cross-contamination between IND and OOD denoising processes.

### Mechanism 2
- Claim: Diffusion models are more prone to hallucination in early-to-mid reverse stages when high-frequency details are being reconstructed.
- Mechanism: Starting local diffusion only after a certain intermediate timestep reduces hallucination because the model has already resolved low-frequency structures, and local processes focus on high-frequency details without global interference.
- Core assumption: The timing of when to switch from global to local diffusion can be determined by classifier confidence or structural similarity metrics.
- Evidence anchors:
  - [section 3.3] "Our analysis of the diffusion models' reverse process reveals that the early to mid-stages are particularly vulnerable to hallucination generation."
  - [section 4.3] "commencing the fusion stage towards the end of the process yields higher classification accuracy and FID."
  - [corpus] Weak: While related to denoising timing, no direct corpus support for this specific diffusion stage hypothesis.
- Break condition: Misidentifying the optimal switching point leads to either unnecessary hallucination (too early) or loss of local detail fidelity (too late).

### Mechanism 3
- Claim: Fusion of local OOD/IND predictions into a global image introduces boundary artifacts that must be resolved by adaptive blending.
- Mechanism: After separate local generations, a fusion module merges predictions using pixel-wise selection based on OOD probability, minimizing abrupt transitions and preserving realism.
- Core assumption: The OOD probability map remains stable and meaningful across the diffusion process, allowing reliable blending decisions.
- Evidence anchors:
  - [section 3.4] "a distinct boundary artifact arises from the local image generation process" and the fusion module addresses this.
  - [section 3.4] "merges the two local generations, which minimizes the creation of hallucinated features."
  - [corpus] Weak: Boundary artifact handling is mentioned but not deeply explored in related works.
- Break condition: OOD probability maps become unreliable due to noise accumulation, causing incorrect blending and visible artifacts.

## Foundational Learning

- Concept: Conditional diffusion models and their reverse process
  - Why needed here: The entire method builds on understanding how diffusion models reconstruct images from noise given conditional inputs.
  - Quick check question: What is the role of the noise scheduler in the reverse diffusion process?

- Concept: Out-of-distribution (OOD) detection and segmentation
  - Why needed here: Accurate OOD detection is critical for partitioning the conditional image and enabling local diffusion.
  - Quick check question: How does PatchCore identify OOD regions without requiring OOD training samples?

- Concept: Evidence Lower Bound (ELBO) and KL divergence in variational inference
  - Why needed here: The hypothesis justification relies on showing that partitioning improves the ELBO by reducing KL divergence.
  - Quick check question: In the context of DDPM, how does conditioning on partitioned data change the ELBO compared to unconditioned data?

## Architecture Onboarding

- Component map: OOD Detector (PatchCore) → Branching Module (parallel local diffusion) → Fusion Module (adaptive blending) → Final Image Output

- Critical path:
  1. OOD detection and mask generation
  2. Branching: parallel local diffusion for IND and OOD regions
  3. Fusion: merging local predictions with noise-aware blending
  4. Optional: classifier-guided refinement of fusion timing

- Design tradeoffs:
  - Soft vs. hard thresholding of OOD maps: soft retains more context but risks hallucination; hard is cleaner but may lose detail.
  - Early vs. late fusion timing: early fusion risks hallucination; late fusion risks boundary artifacts.
  - OOD detector choice: accuracy vs. computational cost and need for OOD training data.

- Failure signatures:
  - Persistent boundary artifacts suggest fusion blending weights are incorrect or OOD maps are noisy.
  - Reduced image quality in IND regions indicates over-aggressive local partitioning.
  - Classifier-guided fusion fails if the classifier is not robust to partial reconstructions.

- First 3 experiments:
  1. Validate OOD detection accuracy on a held-out test set with known anomalies.
  2. Test hallucination reduction by comparing dice coefficients on tumor segmentation before and after applying Local Diffusion.
  3. Evaluate fusion timing by sweeping intermediate timesteps and measuring downstream task accuracy vs. FID trade-off.

## Open Questions the Paper Calls Out

### Open Question 1
- Question: How does the performance of Local Diffusion scale with the size and complexity of the OOD regions in conditional images?
- Basis in paper: [explicit] The paper discusses the impact of OOD segmentation accuracy on performance, but does not systematically explore how varying OOD region sizes and complexities affect the effectiveness of the Local Diffusion approach.
- Why unresolved: The paper provides a qualitative assessment of Local Diffusion's performance on different OOD types, but lacks a quantitative analysis of how OOD region characteristics influence the method's effectiveness.
- What evidence would resolve it: A comprehensive study varying the size and complexity of OOD regions in conditional images, accompanied by quantitative metrics evaluating Local Diffusion's performance across these variations, would provide insights into the method's scalability and robustness.

### Open Question 2
- Question: Can Local Diffusion be extended to handle other types of hallucinations beyond structural hallucinations, such as color or texture hallucinations?
- Basis in paper: [inferred] The paper focuses on structural hallucinations and mentions the potential for future work to explore other hallucination types, such as color or texture, but does not investigate these extensions.
- Why unresolved: The current implementation of Local Diffusion is specifically designed to address structural hallucinations, and its applicability to other hallucination types remains unexplored.
- What evidence would resolve it: Experiments applying Local Diffusion to tasks involving color or texture hallucinations, along with quantitative and qualitative evaluations of its effectiveness in mitigating these hallucinations, would demonstrate the method's versatility and potential for broader applications.

### Open Question 3
- Question: How does the choice of OOD detector impact the performance of Local Diffusion, and are there more efficient or interpretable alternatives to PatchCore?
- Basis in paper: [explicit] The paper discusses the use of PatchCore as the OOD detector and mentions the potential for future research to explore more efficient or interpretable methods, but does not compare different OOD detectors or propose alternatives.
- Why unresolved: The paper relies on PatchCore for OOD detection without investigating the impact of other detectors on Local Diffusion's performance or exploring more efficient or interpretable alternatives.
- What evidence would resolve it: A comparative study evaluating the performance of Local Diffusion with various OOD detectors, including those that are more efficient or interpretable than PatchCore, would provide insights into the optimal choice of OOD detection method for the proposed approach.

## Limitations
- Effectiveness heavily depends on accurate OOD detection, which may not generalize well to complex or subtle anomalies
- Computational overhead of running parallel local diffusion processes
- Scalability to high-resolution images or more complex datasets remains untested

## Confidence

- **High Confidence**: The core hypothesis that partitioning OOD and IND regions reduces hallucination is well-supported by experimental results (e.g., 40% reduction in misdiagnosis for tumor segmentation).
- **Medium Confidence**: The claim about diffusion stage vulnerability to hallucination is plausible but lacks direct empirical validation across diverse datasets.
- **Low Confidence**: The robustness of the fusion module to noisy OOD probability maps is asserted but not rigorously tested under adversarial or noisy conditions.

## Next Checks
1. Test the OOD detector on datasets with subtle or ambiguous anomalies to evaluate its generalization beyond clear-cut cases like tumors.
2. Introduce controlled noise into OOD probability maps during the diffusion process to assess the fusion module's resilience to unreliable inputs.
3. Apply the method to higher-resolution images (e.g., 512x512 or larger) and complex datasets (e.g., natural scene anomaly detection) to evaluate computational feasibility and performance trade-offs.