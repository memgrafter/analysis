---
ver: rpa2
title: Diffusion Models with Implicit Guidance for Medical Anomaly Detection
arxiv_id: '2403.08464'
source_url: https://arxiv.org/abs/2403.08464
tags:
- noise
- anomaly
- thor
- detection
- diffusion
- transformers
- self-attention
- retrieval-augmented-generation
- instruction-tuning
- parameter-efficient-finetuning
- mixture-of-experts
- chain-of-thought
core_contribution: THOR introduces a novel method for unsupervised anomaly detection
  in medical imaging by incorporating implicit guidance into diffusion models via
  temporal anomaly maps. The approach aims to preserve healthy tissue integrity during
  denoising while improving anomaly segmentation accuracy.
---

# Diffusion Models with Implicit Guidance for Medical Anomaly Detection

## Quick Facts
- arXiv ID: 2403.08464
- Source URL: https://arxiv.org/abs/2403.08464
- Authors: Cosmin I. Bercea; Benedikt Wiestler; Daniel Rueckert; Julia A. Schnabel
- Reference count: 17
- One-line primary result: THOR achieves Dice scores up to 29.74% for small lesions and recall rates up to 99.76% for metal implant detection in unsupervised medical anomaly detection.

## Executive Summary
THOR introduces a novel method for unsupervised anomaly detection in medical imaging by incorporating implicit guidance into diffusion models via temporal anomaly maps. The approach aims to preserve healthy tissue integrity during denoising while improving anomaly segmentation accuracy. Experiments on brain MRI stroke lesion segmentation and pediatric wrist X-ray anomaly localization demonstrate THOR outperforms existing diffusion-based methods, achieving Dice scores up to 29.74% for small lesions and recall rates up to 99.76% for metal implant detection. The method shows robustness across different noise types and levels, addressing key limitations of standard diffusion models that often compromise anatomical details and increase false positives.

## Method Summary
THOR (Temporal Harmonization for Optimal Restoration) integrates implicit guidance into diffusion models through temporal anomaly maps. The method uses denoising diffusion probabilistic models (DDPMs) with either Gaussian or Simplex noise, applying anomaly maps at specific timesteps to preserve healthy tissue while detecting anomalies. The framework computes final anomaly scores using harmonic mean of anomaly maps at selected timesteps. The approach was evaluated on brain MRI data (582 T1w MRI scans from IXI dataset + 217 healthy samples from ATLAS v2.0 dataset for training; 655 T1w MRI scans with segmented lesions from ATLAS for testing) and wrist X-ray data (10,643 X-ray images of pediatric wrist injuries from GRAZPEDWRI-DX dataset).

## Key Results
- Achieved Dice scores up to 29.74% for small lesions (< 71 pixels) in brain MRI stroke segmentation
- Attained recall rates up to 99.76% for metal implant detection in pediatric wrist X-ray analysis
- Demonstrated robustness across different noise types (Gaussian and Simplex) and levels

## Why This Works (Mechanism)

### Mechanism 1
- Claim: THOR preserves healthy tissue integrity by selectively harmonizing anomaly maps at intermediate denoising timesteps.
- Mechanism: During the reverse diffusion process, anomaly maps are computed at selected timesteps by comparing the denoised prediction with the original input. These maps are then used to interpolate between the pseudo-healthy prediction and the original image, preserving non-pathological regions.
- Core assumption: The LPIPS-based anomaly map accurately distinguishes healthy from pathological regions, and morphological operations (closing followed by dilation) effectively remove spurious detections.
- Evidence anchors:
  - [abstract] "THOR aims to preserve the integrity of healthy tissue in areas unaffected by pathology."
  - [section] "Anomaly maps m combine residual differences with the Learned Perceptual Image Patch Similarity (LPIPS) metric [13], enhancing the identification of subtle pathological changes [3]."
  - [corpus] Weak evidence - no direct corpus support for LPIPS-based harmonization in diffusion models.
- Break condition: If the anomaly map incorrectly identifies healthy tissue as pathological (false positives), the harmonization will erase genuine anatomical details, leading to degraded segmentation.

### Mechanism 2
- Claim: Using temporal anomaly maps at multiple timesteps provides more robust anomaly scoring than single-step comparisons.
- Mechanism: Anomaly maps are computed at several intermediate timesteps and combined via harmonic mean to produce the final anomaly score, reducing sensitivity to noise and improving detection reliability.
- Core assumption: Multiple intermediate reconstructions capture different aspects of the anomaly, and the harmonic mean is robust to outliers in individual timestep scores.
- Evidence anchors:
  - [section] "The final anomaly score, S, is calculated using the harmonic mean of the anomaly maps at the selected timesteps, explicitly defined as: S = n / Σ_{t∈selected steps} 1/m(xt0, xinput0)."
  - [corpus] No direct corpus evidence; this is a novel contribution of THOR.
- Break condition: If the selected timesteps are poorly chosen (too early or too late in the denoising process), the anomaly maps may be uninformative, leading to unreliable scores.

### Mechanism 3
- Claim: THOR's approach reduces false positives by avoiding the loss of anatomical details that occurs in standard DDPMs at high noise levels.
- Mechanism: By using implicit guidance through temporal anomaly maps, THOR steers the denoising process to preserve healthy tissue structure, even when starting from high noise levels, unlike standard DDPMs that may over-smooth.
- Core assumption: The implicit guidance effectively constrains the denoising trajectory to maintain anatomical fidelity, and the high noise levels are still sufficient to obscure anomalies.
- Evidence anchors:
  - [abstract] "THOR incorporates implicit guidance into diffusion models through the use of temporal anomaly maps, aiming to preserve the original image context while achieving accurate anomaly detection and segmentation."
  - [section] "The innovation of THOR lies in its ability to guide the restoration process by strategically reintegrating healthy tissue information, a technique we refer to as 'harmonization.'"
  - [corpus] Weak evidence - no direct corpus support for implicit guidance reducing false positives in diffusion-based anomaly detection.
- Break condition: If the implicit guidance fails to adequately constrain the denoising process, or if the high noise levels are insufficient to mask anomalies, THOR may still produce false positives or miss detections.

## Foundational Learning

- Concept: Denoising Diffusion Probabilistic Models (DDPMs)
  - Why needed here: THOR builds upon DDPMs as the base generative model for transforming pathological images into pseudo-healthy equivalents.
  - Quick check question: In DDPMs, what is the purpose of the forward process, and how does it relate to the reverse process?

- Concept: Anomaly Detection in Medical Imaging
  - Why needed here: THOR is specifically designed for unsupervised anomaly detection in medical images, requiring an understanding of the unique challenges and evaluation metrics in this domain.
  - Quick check question: What is the key difference between supervised and unsupervised anomaly detection in medical imaging, and why is unsupervised detection particularly challenging?

- Concept: Perceptual Similarity Metrics (LPIPS)
  - Why needed here: THOR uses LPIPS to enhance the identification of subtle pathological changes in the anomaly maps.
  - Quick check question: How does LPIPS differ from traditional pixel-wise similarity metrics, and why is it more suitable for capturing perceptual differences in medical images?

## Architecture Onboarding

- Component map: DDPM backbone -> Anomaly map generator -> Temporal harmonization module -> Anomaly scoring module

- Critical path:
  1. Input noisy image into DDPM
  2. Generate intermediate reconstructions at selected timesteps
  3. Compute anomaly maps for each intermediate reconstruction
  4. Apply morphological operations to refine anomaly maps
  5. Harmonize reconstructions using anomaly maps
  6. Calculate final anomaly score using harmonic mean

- Design tradeoffs:
  - High noise levels vs. preservation of anatomical details
  - Number and selection of timesteps for anomaly map computation
  - Choice of morphological operations for refining anomaly maps
  - Balance between sensitivity and specificity in anomaly detection

- Failure signatures:
  - Loss of anatomical details in healthy regions (false positives)
  - Inability to detect subtle anomalies (false negatives)
  - Sensitivity to noise in anomaly map computation
  - Poor performance on specific anomaly types or image modalities

- First 3 experiments:
  1. Ablation study on the number and selection of timesteps for anomaly map computation
  2. Comparison of different perceptual similarity metrics (e.g., LPIPS vs. SSIM) for anomaly map generation
  3. Sensitivity analysis of morphological operation parameters (e.g., kernel size, iterations) on final segmentation quality

## Open Questions the Paper Calls Out
- How does THOR's performance compare when applied to other medical imaging modalities beyond MRI and X-ray?
- What is the impact of THOR's temporal anomaly map frequency (number and timing of harmonization steps) on anomaly detection accuracy?
- How does THOR handle anomalies that are anatomically similar to healthy tissue structures?

## Limitations
- Limited generalization beyond two imaging modalities (brain MRI and wrist X-rays)
- No evaluation on external datasets or multi-center data
- Fixed noise levels may not be optimal across all anomaly types

## Confidence
- High confidence: THOR outperforms existing diffusion-based methods on benchmark datasets
- Medium confidence: Mechanism 1 (LPIPS-based harmonization) - corpus lacks direct evidence for this specific approach
- Medium confidence: Mechanism 2 (temporal anomaly maps) - novel contribution with limited external validation
- Low confidence: Mechanism 3 (false positive reduction) - claims not fully supported by external evidence

## Next Checks
1. Cross-modal validation: Test THOR on additional medical imaging modalities (CT, ultrasound) to assess generalization beyond MRI and X-ray.
2. External dataset evaluation: Validate performance on independent datasets not used in training to measure true generalization capability.
3. Ablation study on noise levels: Systematically evaluate different noise levels and schedules to determine optimal settings for various anomaly types and sizes.