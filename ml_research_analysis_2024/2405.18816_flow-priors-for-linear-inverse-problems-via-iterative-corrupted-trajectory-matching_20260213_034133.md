---
ver: rpa2
title: Flow Priors for Linear Inverse Problems via Iterative Corrupted Trajectory
  Matching
arxiv_id: '2405.18816'
source_url: https://arxiv.org/abs/2405.18816
tags:
- should
- flow
- problems
- inverse
- answer
- transformers
- self-attention
- retrieval-augmented-generation
- instruction-tuning
- parameter-efficient-finetuning
- mixture-of-experts
- chain-of-thought
core_contribution: This paper introduces ICTM, an iterative algorithm for solving
  linear inverse problems using flow matching priors. The key innovation is approximating
  the MAP objective by decomposing it into a sequence of "local MAP" objectives, which
  are efficiently optimized using gradient-based methods and Tweedie's formula.
---

# Flow Priors for Linear Inverse Problems via Iterative Corrupted Trajectory Matching

## Quick Facts
- arXiv ID: 2405.18816
- Source URL: https://arxiv.org/abs/2405.18816
- Authors: Yasi Zhang; Peiyu Yu; Yaxuan Zhu; Yingshan Chang; Feng Gao; Ying Nian Wu; Oscar Leong
- Reference count: 40
- Primary result: ICTM achieves state-of-the-art PSNR/SSIM on CelebA-HQ and HCP T2w datasets for super-resolution, inpainting, deblurring, and compressed sensing tasks

## Executive Summary
This paper introduces ICTM (Iterative Corrupted Trajectory Matching), an efficient algorithm for solving linear inverse problems using flow matching priors. The key innovation is approximating the MAP objective by decomposing it into a sequence of "local MAP" objectives that can be sequentially optimized using gradient-based methods and Tweedie's formula. This approach avoids the computational bottleneck of backpropagating through ODE solvers while achieving superior reconstruction quality. The method is mathematically justified and empirically validated on both natural images (CelebA-HQ) and medical imaging (HCP T2w) datasets.

## Method Summary
ICTM solves linear inverse problems by iteratively optimizing local MAP objectives that approximate the global MAP objective. Given measurements y = Ax + e, the algorithm initializes a trajectory from Gaussian noise x₀ and generates an auxiliary path yt = αty + βtAx₀. It then sequentially optimizes N local objectives, each corresponding to fitting the corrupted trajectory to the auxiliary path while maintaining likelihood under the flow prior. The optimization uses Tweedie's formula to compute gradients efficiently without solving ODEs, and each local optimization builds on the previous reconstruction. The final output x₁ serves as the reconstructed image.

## Key Results
- Achieves state-of-the-art PSNR/SSIM on CelebA-HQ for super-resolution, inpainting, deblurring, and compressed sensing
- Outperforms existing flow-based methods (OT-ODE, DPS-ODE) on HCP T2w medical imaging dataset
- Reduces computational cost compared to ODE-solver-based approaches while maintaining or improving reconstruction quality
- Demonstrates consistent improvements across multiple tasks and evaluation metrics

## Why This Works (Mechanism)

### Mechanism 1
- Claim: ICTM approximates the MAP objective by decomposing it into N "local MAP" objectives that can be sequentially optimized.
- Mechanism: The global MAP objective is split into N local objectives, each corresponding to an intermediate trajectory point. These are weighted by γᵢ = (1/2)^(N-i+1) and optimized sequentially using Tweedie's formula for gradient computation.
- Core assumption: The trajectory {xₜ} exactly follows the interpolation path αₜx + βₜx₀, allowing the corrupted trajectory uₜ = A(xₜ) to match an auxiliary path yₜ = αₜy + βₜA(x₀).
- Evidence anchors:
  - [abstract] "Our algorithm is mathematically justified by the observation that the MAP objective can be approximated by a sum of N 'local MAP' objectives"
  - [section] Theorem 1 proves that log p(x(x₀)|y) ≈ ΣγᵢĴᵢ as N→∞
  - [corpus] OT-ODE and DPS-ODE also use flow-based approaches but require backpropagation through ODE solvers, making them slower than ICTM's local optimization
- Break condition: The approximation breaks when the trajectory deviates significantly from the interpolation path, violating the compliance assumption. This occurs when the velocity field vθ has high non-uniformity or when the interpolation path poorly represents the true data manifold.

### Mechanism 2
- Claim: Tweedie's formula enables efficient gradient computation of log p(xₜ) without solving ODEs.
- Mechanism: The score function ∇xₜlog p(xₜ) is expressed in terms of the velocity field vθ and interpolation coefficients αₜ, βₜ, avoiding expensive trace computations through ODE solvers.
- Core assumption: The flow model vθ is uniformly Lipschitz continuous in xₜ and continuous in t, ensuring the Jacobian ∂vθ/∂x exists and is bounded.
- Evidence anchors:
  - [section] "By leveraging Tweedie's formula, we show that we can perform gradient steps to sequentially optimize these objectives"
  - [section] Proposition 1 provides the exact relationship between ∇xₜlog p(xₜ) and vθ
  - [corpus] Score-based diffusion methods also use score functions but require thousands of steps; ICTM achieves similar results with fewer iterations
- Break condition: When the Jacobian of vθ becomes ill-conditioned or the Lipschitz constant grows unboundedly, the Tweedie formula approximation fails, leading to unstable gradient updates.

### Mechanism 3
- Claim: Sequential optimization of local MAP objectives converges to the global MAP solution.
- Mechanism: Each local objectiveĴᵢ = log p(yᵢ∆ₜ|xᵢ∆ₜ) + log p(x₍ᵢ₋₁₎∆ₜ) - tr(∂vθ/∂x)∆ₜ is optimized in sequence, with each step building on the previous reconstruction, ensuring the final x₁ fits both measurements and the prior.
- Core assumption: The local posteriors Ji are approximately factorized and can be optimized independently without losing global coherence.
- Evidence anchors:
  - [abstract] "By leveraging Tweedie's formula, we show that we can perform gradient steps to sequentially optimize these objectives"
  - [section] "Optimizing each of these local posterior distributions in a sequential fashion captures the fact that we would like each intermediate point in our trajectory to be likely and fit to our measurements"
  - [corpus] ΠGDM uses sequential refinement but with diffusion models; ICTM achieves better PSNR/SSIM with flow priors
- Break condition: When the local objectives conflict significantly (e.g., due to highly non-convex measurement operators), sequential optimization can get stuck in local minima that don't correspond to the global MAP solution.

## Foundational Learning

- Concept: Maximum A Posteriori (MAP) estimation
  - Why needed here: The paper solves linear inverse problems by finding the most probable image given measurements and a flow prior
  - Quick check question: In MAP estimation, what are the two components of the objective function being maximized?

- Concept: Flow matching models and instantaneous change-of-variables
  - Why needed here: Flow models provide the prior p(x) through their invertibility, allowing direct computation of image likelihoods via the log-determinant of the Jacobian
  - Quick check question: How does the change-of-variables formula relate the probability of x₁ to the probability of the initial noise x₀?

- Concept: ODE solvers and backpropagation through differential equations
  - Why needed here: Standard MAP with flow priors requires backpropagating through ODE solvers to compute log-likelihoods, which is computationally prohibitive; ICTM avoids this
  - Quick check question: Why is backpropagating through an ODE solver computationally expensive compared to standard neural network layers?

## Architecture Onboarding

- Component map: Measurement y -> initialize x₀ ~ N(0,I) -> generate yt auxiliary path -> iteratively optimize local objectives -> return x₁ as reconstruction
- Critical path: Measurement y → initialize x₀ ~ N(0,I) → generate yt auxiliary path → iteratively optimize local objectives → return x₁ as reconstruction
- Design tradeoffs: ICTM trades off between local optimization (faster, more stable) and global coherence (risk of local minima); increasing N improves approximation but increases computation
- Failure signatures: Poor reconstructions with artifacts suggest trajectory compliance violations; unstable training indicates Jacobian issues; local minima appear as "good" intermediate steps but poor final reconstruction
- First 3 experiments:
  1. Toy denoising with known MAP solution to validate convergence
  2. Super-resolution on CelebA-HQ to test natural image performance
  3. Compressed sensing on HCP to validate medical imaging applicability

## Open Questions the Paper Calls Out

### Open Question 1
- Question: How does the performance of ICTM scale with the number of function evaluations (NFEs) for very high-dimensional problems?
- Basis in paper: [explicit] The paper discusses the approximation of the MAP objective using N "local MAP" objectives, where N is the number of function evaluations.
- Why unresolved: The paper validates the method empirically for a range of NFEs (N=100) but does not explore the limits of scalability for extremely high-dimensional problems or the point at which increasing N ceases to provide meaningful improvements.
- What evidence would resolve it: Systematic experiments varying N across a wider range of dimensions and problem complexities, coupled with theoretical analysis of computational complexity and convergence rates as a function of N.

### Open Question 2
- Question: Can ICTM be extended to handle nonlinear forward models beyond the linear inverse problems studied in this paper?
- Basis in paper: [inferred] The paper focuses on linear inverse problems and mentions in the limitations that generalizing to nonlinear forward models is an important direction for future work.
- Why unresolved: The current algorithm relies on the linearity of the forward operator A to efficiently compute the auxiliary path yt = αty + βtAx₀. Nonlinear operators would complicate this computation.
- What evidence would resolve it: Development of a generalized version of ICTM for nonlinear operators, along with empirical validation on a diverse set of nonlinear inverse problems.

### Open Question 3
- Question: How can the uncertainty of the generated images be quantified using ICTM?
- Basis in paper: [explicit] The paper mentions in the limitations that the algorithm currently lacks the capability to quantify the uncertainty of the generated images, which is crucial for many scientific applications.
- Why unresolved: ICTM is designed to find a single MAP estimate, not to characterize the full posterior distribution. Quantifying uncertainty would require additional computational methods.
- What evidence would resolve it: Integration of uncertainty quantification techniques (e.g., Bayesian methods, Monte Carlo sampling) with ICTM, and demonstration of their effectiveness in providing reliable uncertainty estimates for image reconstruction tasks.

## Limitations

- The theoretical analysis relies on the trajectory compliance assumption (xₜ = αₜx + βₜx₀), which may not hold for all flow matching models or inverse problem types
- The local optimization approach trades global optimality for computational efficiency, potentially converging to suboptimal solutions when local objectives conflict significantly
- The method inherits limitations from pretrained flow models, including potential mode collapse and limited expressiveness for complex data distributions

## Confidence

**High confidence** in the empirical results and algorithmic framework - the PSNR/SSIM improvements are substantial and consistent across multiple tasks and datasets. The theoretical derivation is rigorous, though the practical implications of the compliance assumption remain to be fully validated. The Tweedie's formula application appears sound based on the mathematical proofs provided.

**Medium confidence** in the claim that ICTM universally outperforms existing methods - while results show consistent improvements, the comparisons are limited to specific flow-based approaches and may not generalize to all inverse problem solvers. The computational efficiency claims relative to ODE-solver-based methods are plausible but would benefit from detailed runtime analysis.

**Low confidence** in the robustness of ICTM to highly non-convex measurement operators and ill-conditioned problems - the sequential optimization framework may struggle when local objectives have significant conflicts or when the flow prior poorly represents the data manifold.

## Next Checks

1. **Compliance Assumption Validation**: Systematically test how deviations from the trajectory compliance assumption (xₜ = αₜx + βₜx₀) affect reconstruction quality across different flow models and inverse problems.

2. **Computational Efficiency Benchmarking**: Conduct detailed runtime analysis comparing ICTM to ODE-solver-based methods, measuring not just wall-clock time but also memory usage and gradient computation costs.

3. **Generalization Across Problem Types**: Evaluate ICTM on a broader range of inverse problems including blind deconvolution, phase retrieval, and nonlinear measurements to assess robustness beyond the linear cases studied.