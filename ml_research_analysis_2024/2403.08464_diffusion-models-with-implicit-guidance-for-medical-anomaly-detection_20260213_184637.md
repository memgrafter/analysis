---
ver: rpa2
title: Diffusion Models with Implicit Guidance for Medical Anomaly Detection
arxiv_id: '2403.08464'
source_url: https://arxiv.org/abs/2403.08464
tags:
- noise
- anomaly
- thor
- detection
- diffusion
- transformers
- self-attention
- retrieval-augmented-generation
- instruction-tuning
- parameter-efficient-finetuning
- mixture-of-experts
- chain-of-thought
core_contribution: This work addresses the challenge of preserving healthy tissue
  integrity during the denoising process in diffusion models for medical anomaly detection.
  The proposed method, THOR (Temporal Harmonization for Optimal Restoration), integrates
  implicit guidance through temporal anomaly maps into the de-noising process.
---

# Diffusion Models with Implicit Guidance for Medical Anomaly Detection

## Quick Facts
- arXiv ID: 2403.08464
- Source URL: https://arxiv.org/abs/2403.08464
- Authors: Cosmin I. Bercea; Benedikt Wiestler; Daniel Rueckert; Julia A. Schnabel
- Reference count: 17
- Primary result: 20-65% improvement in anomaly detection across brain MRI and wrist X-ray datasets

## Executive Summary
This work addresses the challenge of preserving healthy tissue integrity during the denoising process in diffusion models for medical anomaly detection. The proposed method, THOR (Temporal Harmonization for Optimal Restoration), integrates implicit guidance through temporal anomaly maps into the de-noising process. This approach aims to maintain the fidelity of unaffected regions while accurately detecting and segmenting anomalies. THOR was evaluated on brain MRI stroke lesion segmentation and pediatric wrist X-ray anomaly localization, demonstrating superior performance compared to existing diffusion-based methods.

## Method Summary
THOR uses implicit guidance through temporal anomaly maps integrated into the denoising process of diffusion models. It refines the denoising trajectory to preserve healthy tissue while detecting anomalies by generating intermediate anomaly maps at selected timesteps. These maps are created by comparing pseudo-healthy reconstructions to the original input using residual differences weighted by LPIPS, then normalized and morphologically processed. The method was tested on brain MRI datasets (IXI and ATLAS) and wrist X-ray datasets (GRAZPEDWRI-DX), with performance measured using Dice scores for brain MRI and Recall/F1 scores for wrist X-rays.

## Key Results
- THOR achieved a 20% improvement in Dice score for stroke segmentation using Gaussian noise and a 33% improvement with Simplex noise
- For wrist X-ray anomaly localization, THOR showed up to 65% improvement in fracture detection recall and near-perfect recall for metal implant detection
- The method demonstrated robustness across different noise levels and reduced false positives compared to baseline diffusion-based methods

## Why This Works (Mechanism)

### Mechanism 1
THOR improves anomaly segmentation accuracy by harmonizing intermediate denoising steps using temporal anomaly maps, preserving healthy tissue structure while progressively reducing anomaly regions. At selected timesteps during the denoising trajectory, THOR generates anomaly maps by comparing pseudo-healthy reconstructions to the original input, using residual differences weighted by LPIPS. These maps are normalized and morphologically processed, then used to blend original healthy tissue with denoised predictions, selectively attenuating anomalies. The core assumption is that intermediate denoising states contain sufficient contrast between healthy and anomalous regions to allow reliable unsupervised anomaly detection.

### Mechanism 2
Using Simplex noise instead of Gaussian noise reduces the need for high noise levels, preserving more original image context and improving restoration fidelity. Simplex noise's coarse patterns allow the denoising process to start at lower T (250 vs 350), reducing the distortion of healthy tissue. This provides a stronger foundation for the harmonization process to build upon, as more original context remains available. The core assumption is that coarse noise patterns are sufficient to obscure anomalies while preserving healthy tissue structure.

### Mechanism 3
THOR's sensitivity to noise level and type enables robust performance across different anomaly sizes and imaging conditions. The method's performance improves with higher Gaussian noise levels for large lesions due to better masking, while maintaining stability at lower Simplex noise levels. The temporal harmonization process compensates for noise-induced degradation of healthy tissue. The core assumption is that the optimal noise level and type vary with anomaly size and modality, and THOR can adapt to these variations.

## Foundational Learning

- **Denoising Diffusion Probabilistic Models (DDPMs)**: THOR builds on DDPM's noise addition and removal process, modifying the inference phase with temporal harmonization. Quick check: What is the forward process in a DDPM, and how does it transform a clean image into noise?

- **Anomaly detection as deviation from healthy tissue distribution**: THOR frames anomaly detection as identifying regions that deviate from the learned healthy tissue distribution during denoising. Quick check: How does unsupervised anomaly detection differ from supervised classification in medical imaging?

- **Perceptual similarity metrics (LPIPS)**: THOR uses LPIPS-weighted residuals to create anomaly maps that capture subtle pathological changes beyond pixel-wise differences. Quick check: What advantage does LPIPS offer over simple L1/L2 distance in detecting perceptual anomalies?

## Architecture Onboarding

- **Component map**: Original image -> DDPM denoising -> intermediate anomaly map generation -> harmonization -> final reconstruction -> anomaly scoring
- **Critical path**: Original image → DDPM denoising → intermediate anomaly map generation → harmonization → final reconstruction → anomaly scoring
- **Design tradeoffs**: High noise levels improve anomaly masking but degrade healthy tissue; THOR mitigates this via harmonization. Simplex noise preserves context but may introduce self-supervision bias; Gaussian noise is more general but requires higher levels. Number of harmonization timesteps affects both accuracy and computational cost.
- **Failure signatures**: Poor anomaly detection when healthy and anomalous tissue have similar structure or intensity. False positives from unannotated non-pathological changes (e.g., casts, unnatural positions). Performance degradation with very low or very high noise levels relative to anomaly size.
- **First 3 experiments**: 1) Ablation study: Compare THOR with and without temporal harmonization at various noise levels on a small dataset. 2) Noise type comparison: Test Gaussian vs. Simplex noise with THOR on a single modality to observe bias patterns. 3) Sensitivity analysis: Vary the number of harmonization timesteps and measure impact on Dice/F1 scores.

## Open Questions the Paper Calls Out

### Open Question 1
How does the performance of THOR scale with different types of pathologies beyond stroke lesions and wrist fractures, particularly for subtle or rare anomalies? The paper demonstrates THOR's effectiveness on stroke lesions and wrist fractures but notes the challenge of detecting subtle anomalies like soft tissue conditions and mentions the need to improve diagnostic precision across a diverse array of anomalies. Conducting experiments with a wider variety of pathologies, including rare and subtle anomalies, and comparing THOR's performance against existing methods on these diverse datasets would provide evidence of its generalizability and effectiveness.

### Open Question 2
What is the impact of THOR's temporal harmonization process on the computational efficiency and runtime compared to traditional DDPM methods? The paper introduces the novel concept of temporal harmonization but does not discuss its computational implications or compare the runtime efficiency of THOR with other diffusion-based methods. Benchmarking the runtime and computational resources required by THOR, including the temporal harmonization process, against traditional DDPM methods across various hardware configurations would provide insights into its efficiency.

### Open Question 3
How does THOR handle anomalies that are structurally similar to the noise patterns used in the diffusion process, particularly with Simplex noise? The paper discusses the self-supervision effect of Simplex noise, where anomalies similar to the coarse noise pattern are identified and eliminated, and notes that this may limit its effectiveness in broader anomaly detection scenarios. Experimenting with variations of THOR that adjust the harmonization process or noise patterns to better handle anomalies similar to the noise structure, and evaluating the performance improvements, would address this question.

## Limitations

- Performance claims rely heavily on synthetic noise augmentation rather than real-world clinical variability
- Method's dependence on LPIPS for anomaly map generation introduces sensitivity to the quality of pseudo-healthy reconstructions
- Computational overhead of temporal harmonization at multiple timesteps could limit clinical deployment

## Confidence

- **High Confidence**: The core mechanism of temporal anomaly map integration for preserving healthy tissue during denoising is well-specified and theoretically sound
- **Medium Confidence**: Performance improvements (20-65%) are demonstrated on benchmark datasets but may not generalize across diverse clinical settings
- **Low Confidence**: Claims about robustness to different noise levels and types are based on controlled experiments that may not reflect real-world imaging variability

## Next Checks

1. **Cross-Institutional Validation**: Test THOR on multi-center datasets with varying acquisition protocols to assess robustness to real-world imaging variability
2. **Computational Efficiency Analysis**: Measure inference time and resource requirements across different hardware configurations to evaluate clinical deployment feasibility
3. **Failure Mode Characterization**: Systematically evaluate performance on challenging cases including small lesions, subtle anomalies, and anatomical variants not well-represented in training data