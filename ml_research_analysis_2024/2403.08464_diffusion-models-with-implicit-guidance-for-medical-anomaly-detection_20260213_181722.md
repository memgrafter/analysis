---
ver: rpa2
title: Diffusion Models with Implicit Guidance for Medical Anomaly Detection
arxiv_id: '2403.08464'
source_url: https://arxiv.org/abs/2403.08464
tags:
- noise
- anomaly
- thor
- detection
- diffusion
- transformers
- self-attention
- retrieval-augmented-generation
- instruction-tuning
- parameter-efficient-finetuning
- mixture-of-experts
- chain-of-thought
core_contribution: This work addresses the challenge of preserving healthy tissue
  integrity during the denoising process in diffusion models for medical anomaly detection.
  The proposed method, THOR (Temporal Harmonization for Optimal Restoration), integrates
  implicit guidance through temporal anomaly maps into the de-noising process.
---

# Diffusion Models with Implicit Guidance for Medical Anomaly Detection

## Quick Facts
- arXiv ID: 2403.08464
- Source URL: https://arxiv.org/abs/2403.08464
- Reference count: 17
- Primary result: THOR improves anomaly detection in brain MRI and wrist X-rays using temporal harmonization

## Executive Summary
This paper introduces THOR (Temporal Harmonization for Optimal Restoration), a method that enhances diffusion models for unsupervised medical anomaly detection by integrating implicit guidance through temporal anomaly maps. The approach addresses the challenge of preserving healthy tissue integrity during denoising by harmonizing intermediate denoising steps using anomaly maps generated from residual differences weighted by LPIPS. THOR demonstrates significant improvements over existing diffusion-based methods, achieving up to 65% improvement in fracture detection recall and 33% improvement in brain MRI stroke segmentation with Simplex noise.

## Method Summary
THOR modifies the denoising diffusion probabilistic model (DDPM) framework by incorporating temporal anomaly maps into the denoising process. At selected timesteps during the denoising trajectory, THOR generates anomaly maps by comparing pseudo-healthy reconstructions to the original input using residual differences weighted by LPIPS. These maps are normalized and morphologically processed, then used to blend original healthy tissue with denoised predictions, selectively attenuating anomalies. The method leverages both Gaussian and Simplex noise, with Simplex providing advantages through coarse noise patterns that preserve more original image context. The approach is evaluated on brain MRI stroke lesion segmentation and pediatric wrist X-ray anomaly localization.

## Key Results
- THOR achieved 20% improvement in Dice score for stroke segmentation using Gaussian noise and 33% improvement with Simplex noise
- For wrist X-ray anomaly localization, THOR showed up to 65% improvement in fracture detection recall
- Near-perfect recall for metal implant detection, demonstrating robustness to non-pathological anomalies
- THOR demonstrates robustness across different noise levels and reduces false positives compared to existing methods

## Why This Works (Mechanism)

### Mechanism 1
THOR improves anomaly segmentation accuracy by harmonizing intermediate denoising steps using temporal anomaly maps, preserving healthy tissue structure while progressively reducing anomaly regions. At selected timesteps during the denoising trajectory, THOR generates anomaly maps by comparing pseudo-healthy reconstructions to the original input, using residual differences weighted by LPIPS. These maps are normalized and morphologically processed, then used to blend original healthy tissue with denoised predictions, selectively attenuating anomalies. The intermediate denoising states contain sufficient contrast between healthy and anomalous regions to allow reliable unsupervised anomaly detection.

### Mechanism 2
Using Simplex noise instead of Gaussian noise reduces the need for high noise levels, preserving more original image context and improving restoration fidelity. Simplex noise's coarse patterns allow the denoising process to start at lower T (250 vs 350), reducing the distortion of healthy tissue. This provides a stronger foundation for the harmonization process to build upon, as more original context remains available. Coarse noise patterns are sufficient to obscure anomalies while preserving healthy tissue structure.

### Mechanism 3
THOR's sensitivity to noise level and type enables robust performance across different anomaly sizes and imaging conditions. The method's performance improves with higher Gaussian noise levels for large lesions due to better masking, while maintaining stability at lower Simplex noise levels. The temporal harmonization process compensates for noise-induced degradation of healthy tissue. The optimal noise level and type vary with anomaly size and modality, and THOR can adapt to these variations.

## Foundational Learning

- **Denoising Diffusion Probabilistic Models (DDPMs)**: THOR builds on DDPM's noise addition and removal process, modifying the inference phase with temporal harmonization. What is the forward process in a DDPM, and how does it transform a clean image into noise?

- **Anomaly detection as deviation from healthy tissue distribution**: THOR frames anomaly detection as identifying regions that deviate from the learned healthy tissue distribution during denoising. How does unsupervised anomaly detection differ from supervised classification in medical imaging?

- **Perceptual similarity metrics (LPIPS)**: THOR uses LPIPS-weighted residuals to create anomaly maps that capture subtle pathological changes beyond pixel-wise differences. What advantage does LPIPS offer over simple L1/L2 distance in detecting perceptual anomalies?

## Architecture Onboarding

- **Component map**: Original image → DDPM denoising → intermediate anomaly map generation → harmonization → final reconstruction → anomaly scoring
- **Critical path**: The model processes the original image through DDPM denoising, generates intermediate anomaly maps at selected timesteps, applies harmonization to blend healthy tissue, produces final reconstruction, and calculates anomaly scores
- **Design tradeoffs**: High noise levels improve anomaly masking but degrade healthy tissue; THOR mitigates this via harmonization. Simplex noise preserves context but may introduce self-supervision bias; Gaussian noise is more general but requires higher levels. Number of harmonization timesteps affects both accuracy and computational cost
- **Failure signatures**: Poor anomaly detection when healthy and anomalous tissue have similar structure or intensity. False positives from unannotated non-pathological changes (e.g., casts, unnatural positions). Performance degradation with very low or very high noise levels relative to anomaly size
- **First 3 experiments**: 1) Ablation study: Compare THOR with and without temporal harmonization at various noise levels on a small dataset. 2) Noise type comparison: Test Gaussian vs. Simplex noise with THOR on a single modality to observe bias patterns. 3) Sensitivity analysis: Vary the number of harmonization timesteps and measure impact on Dice/F1 scores

## Open Questions the Paper Calls Out

- **Open Question 1**: How does the performance of THOR scale with different types of pathologies beyond stroke lesions and wrist fractures, particularly for subtle or rare anomalies? The paper demonstrates THOR's effectiveness on stroke lesions and wrist fractures but notes the challenge of detecting subtle anomalies like soft tissue conditions and mentions the need to improve diagnostic precision across a diverse array of anomalies. Conducting experiments with a wider variety of pathologies, including rare and subtle anomalies, would provide evidence of its generalizability.

- **Open Question 2**: What is the impact of THOR's temporal harmonization process on the computational efficiency and runtime compared to traditional DDPM methods? The paper introduces the novel concept of temporal harmonization but does not discuss its computational implications or compare the runtime efficiency of THOR with other diffusion-based methods. Benchmarking the runtime and computational resources required by THOR against traditional DDPM methods would provide insights into its efficiency.

- **Open Question 3**: How does THOR handle anomalies that are structurally similar to the noise patterns used in the diffusion process, particularly with Simplex noise? The paper discusses the self-supervision effect of Simplex noise, where anomalies similar to the coarse noise pattern are identified and eliminated, and notes that this may limit its effectiveness in broader anomaly detection scenarios. Experimenting with variations of THOR that adjust the harmonization process or noise patterns would address this limitation.

## Limitations

- Evaluation relies on curated datasets that may not reflect clinical variability and real-world deployment challenges
- Simplex noise advantage may introduce self-supervision bias for anomalies with coarse structures
- Optimal noise level remains modality- and anomaly-size dependent, limiting generalization
- Temporal harmonization adds computational complexity that may limit real-time applicability

## Confidence

- **High confidence**: THOR improves over baseline diffusion models on curated datasets; the temporal harmonization mechanism is well-defined and reproducible
- **Medium confidence**: Claims of robustness across noise types and levels are supported but may not generalize to all anomaly types or imaging modalities
- **Low confidence**: The clinical impact of false positives from non-pathological anomalies is not quantified; the self-supervision risk of Simplex noise is acknowledged but not fully explored

## Next Checks

1. **Cross-dataset robustness**: Validate THOR on external, multi-center datasets with varying acquisition protocols to assess generalization
2. **Bias analysis**: Systematically evaluate Simplex noise's self-supervision bias by testing on anomalies with coarse vs. fine structures
3. **Real-world deployment**: Simulate clinical workflows with unannotated anomalies (e.g., metal implants, casts) to quantify false positive impact and model adaptability