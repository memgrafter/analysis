---
ver: rpa2
title: Latent 3D Brain MRI Counterfactual
arxiv_id: '2409.05585'
source_url: https://arxiv.org/abs/2409.05585
tags: []
core_contribution: This paper presents a novel two-stage method for generating high-fidelity
  3D brain MRI counterfactuals by integrating a structural causal model within the
  latent space of a VQ-VAE. The key innovation is using a generalized linear model
  (GLM) to efficiently perform the abduction, action, and prediction steps of counterfactual
  inference in the low-dimensional latent space, avoiding the computational challenges
  of working directly in high-dimensional MRI space.
---

# Latent 3D Brain MRI Counterfactual

## Quick Facts
- arXiv ID: 2409.05585
- Source URL: https://arxiv.org/abs/2409.05585
- Authors: Wei Peng; Tian Xia; Fabio De Sousa Ribeiro; Tomas Bosschieter; Ehsan Adeli; Qingyu Zhao; Ben Glocker; Kilian M. Pohl
- Reference count: 33
- One-line primary result: Novel two-stage method generates high-fidelity 3D brain MRI counterfactuals using VQ-VAE latent space and GLM for efficient causal inference

## Executive Summary
This paper presents a novel two-stage method for generating high-fidelity 3D brain MRI counterfactuals by integrating a structural causal model within the latent space of a VQ-VAE. The key innovation is using a generalized linear model (GLM) to efficiently perform the abduction, action, and prediction steps of counterfactual inference in the low-dimensional latent space, avoiding the computational challenges of working directly in high-dimensional MRI space. Experiments on real-world high-resolution (1mm) MRI data demonstrate the model's ability to generate anatomically plausible counterfactuals with strong performance in brain region segmentation compared to baseline generative models like GANs and diffusion models.

## Method Summary
The method operates in two stages: first, a VQ-VAE compresses 3D brain MRIs into a compact latent representation that preserves spatial structure. Second, a structural causal model is learned in this latent space using a generalized linear model (GLM) to efficiently compute counterfactuals through closed-form solutions. The GLM performs the three-step counterfactual procedure (abduction, action, prediction) by computing linear parameters B = (P^T P)^(-1)P^T Z, then using these to generate counterfactual latent features bZ = UZ + bPB, which are decoded back to MRI space. The approach uses fine-grained quantization with residual encoding to improve reconstruction quality while maintaining computational efficiency.

## Key Results
- VQ-VAE with fine-grained quantization achieves high-quality reconstruction of 3D brain MRIs in latent space
- GLM-based counterfactual computation in latent space generates anatomically plausible brain MRI counterfactuals
- Counterfactual MRIs show strong segmentation performance and effect size preservation compared to real data
- Method outperforms baseline GAN and diffusion models in anatomical plausibility metrics

## Why This Works (Mechanism)

### Mechanism 1
- Claim: The VQ-VAE encoder compresses high-dimensional 3D MRI into a lower-dimensional latent space that preserves spatial structure needed for reconstruction.
- Mechanism: Encoder maps 3D MRI x ∈ R^{D×H×W} to latent feature z ∈ R^{d×h×w×nD} while decoder reconstructsˆx = D(z), enabling compact representation.
- Core assumption: Spatial relationships in MRI are preserved through VQ-VAE encoding and quantization.
- Evidence anchors:
  - [abstract] "In the first stage, we employ a VQ-VAE to learn a compact embedding of the MRI volume."
  - [section] "To obtain a latent feature z from a 3D MRI x, we employ a Variational Autoencoder (VQ-VAE)."
- Break condition: If VQ-VAE fails to preserve spatial relationships or quantization introduces artifacts that decoder cannot recover.

### Mechanism 2
- Claim: GLM in latent space efficiently computes counterfactual features through closed-form solution, avoiding computational complexity of high-dimensional space.
- Mechanism: GLM solves B = (P^T P)^{-1}P^T Z for linear parameters, then computes UZ = Z - PB as exogenous variables, and finally bZ = UZ + bPB for counterfactual features.
- Core assumption: Linear relationship between latent features and parent attributes holds in latent space.
- Evidence anchors:
  - [abstract] "execute a three-step counterfactual procedure using a closed-form Generalized Linear Model (GLM)."
  - [section] "we first flatten the feature as a vector with dimension K = d × h × w × nD... an ordinary least square estimator [13] is applied to solve the GLM's normal equations so that the linear parameters B can be represented by the closed-form solution."
- Break condition: If latent space relationships are non-linear or high correlation between parent attributes makes (P^T P) singular.

### Mechanism 3
- Claim: Vector quantization with residual encoding provides fine-grained quantization that improves reconstruction quality while maintaining computational efficiency.
- Mechanism: Each latent vector zh is quantized to nearest codebook entry e(I(zh)), then residual zh - e(I(zh)) is also quantized, and combined as Q(zh) = e(I(zh)) + e(I(zh - e(I(zh)))).
- Core assumption: Residual information provides meaningful additional quantization beyond simple nearest neighbor.
- Evidence anchors:
  - [section] "we propose a fine-grained quantization process that acquires multiple quantizations per vector, namely the vector's own quantization as well as the quantization of its residual."
- Break condition: If residual quantization provides negligible improvement or increases codebook size beyond practical limits.

## Foundational Learning

- Concept: Structural Causal Models (SCMs) and the three-step counterfactual procedure (abduction, action, prediction)
  - Why needed here: The paper builds its method on causal inference principles to generate counterfactual brain MRIs with interventions on attributes like age and diagnosis.
  - Quick check question: What are the three steps of counterfactual inference in SCMs and what does each step accomplish?

- Concept: Vector quantization and embedding in VQ-VAEs
  - Why needed here: The method uses VQ-VAE to compress MRI data into a discrete latent space where causal modeling can be efficiently performed.
  - Quick check question: How does vector quantization in VQ-VAE differ from continuous latent spaces in standard VAEs?

- Concept: Generalized Linear Models and closed-form solutions
  - Why needed here: GLM provides the closed-form solution for computing counterfactuals in the latent space, avoiding iterative optimization.
  - Quick check question: Why is a closed-form solution computationally advantageous compared to iterative methods for counterfactual inference?

## Architecture Onboarding

- Component map: VQ-VAE (encoder, decoder, codebook) → GLM computation (feature matrix Z, parent matrix P, parameter matrix B) → Causal graph intervention → Counterfactual reconstruction
- Critical path: MRI → VQ-VAE encoding → GLM counterfactual computation → Vector quantization with residuals → VQ-VAE decoding → Counterfactual MRI
- Design tradeoffs: Latent space dimensionality vs. reconstruction quality vs. computational efficiency of GLM; codebook size vs. quantization granularity vs. memory requirements
- Failure signatures: Poor reconstruction quality indicates VQ-VAE issues; non-anatomical counterfactuals suggest causal model problems; slow computation suggests GLM matrix inversion issues
- First 3 experiments:
  1. Train VQ-VAE on synthetic 3D MRI data and verify reconstruction quality with varying latent dimensions
  2. Implement GLM counterfactual computation on pre-trained VQ-VAE latent features with synthetic attribute interventions
  3. Combine VQ-VAE and GLM to generate counterfactuals on real MRI data and evaluate anatomical plausibility using segmentation tools

## Open Questions the Paper Calls Out

### Open Question 1
- Question: How can the anatomical plausibility of counterfactuals be rigorously assessed when intervening on diagnosis, given these represent novel findings?
- Basis in paper: [explicit] Section 4 states that assessing anatomical plausibility for diagnosis interventions is "non-trivial" as these "present novel findings"
- Why unresolved: The paper acknowledges this is challenging but does not propose a solution or methodology for evaluation
- What evidence would resolve it: Development and validation of a framework for evaluating counterfactual anatomical plausibility when creating novel pathological findings

### Open Question 2
- Question: Can the computational efficiency gains from performing GLM in latent space be maintained when scaling to larger datasets with more complex causal structures?
- Basis in paper: [inferred] Section 2.2 mentions the method is "scalable and easily lends itself to cases containing many more samples" but does not provide empirical validation
- Why unresolved: The paper demonstrates the method works for the studied dataset but does not test scalability limits
- What evidence would resolve it: Performance benchmarks showing computational time and quality metrics across datasets of increasing size and complexity

### Open Question 3
- Question: How does the quality of counterfactual generation compare when using different vector quantization strategies beyond the "fine-grained quantization process" described?
- Basis in paper: [explicit] Section 2.2 describes a specific "fine-grained quantization process" but does not compare it to alternatives
- Why unresolved: The paper presents one quantization method without exploring whether it is optimal
- What evidence would resolve it: Systematic comparison of counterfactual generation quality across multiple quantization strategies with the same causal modeling framework

## Limitations
- The method assumes linear relationships in latent space may not capture complex non-linear anatomical variations
- VQ-VAE's ability to preserve spatial relationships during quantization is critical but not extensively validated for pathological brain structures
- Causal graph construction and variable selection remain somewhat underspecified, potentially limiting generalizability

## Confidence
- **High Confidence**: The two-stage architectural approach (VQ-VAE + GLM) is well-founded and the reconstruction quality on healthy brain MRI data is validated
- **Medium Confidence**: The closed-form GLM solution for counterfactual computation is theoretically sound, but real-world performance with diverse brain pathologies needs further validation
- **Medium Confidence**: The anatomical plausibility assessment through segmentation comparison is appropriate, though limited to 24 subcortical regions

## Next Checks
1. Test counterfactual generation on MRI data containing clear pathological markers (tumors, lesions) to evaluate robustness beyond healthy brain structures
2. Perform ablation studies comparing reconstruction quality and counterfactual plausibility with different latent space dimensionalities and codebook sizes
3. Validate the causal graph assumptions by testing counterfactual generation with known intervention effects from clinical studies on brain development and disease progression