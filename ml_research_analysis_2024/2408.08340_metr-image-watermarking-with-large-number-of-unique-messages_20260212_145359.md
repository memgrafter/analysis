---
ver: rpa2
title: 'METR: Image Watermarking with Large Number of Unique Messages'
arxiv_id: '2408.08340'
source_url: https://arxiv.org/abs/2408.08340
tags:
- metr
- image
- watermark
- detection
- diffusion
- transformers
- self-attention
- retrieval-augmented-generation
- instruction-tuning
- parameter-efficient-finetuning
- mixture-of-experts
- chain-of-thought
core_contribution: The paper presents METR, a watermarking algorithm for diffusion
  models that can embed multiple unique messages (e.g., user IDs) while maintaining
  robustness to attacks and image quality. Built on the Tree-Ring watermarking approach,
  METR encodes binary messages as concentric circles in the Fourier space of the initial
  noise, using a radius parameter to determine the number of possible messages and
  a scale parameter to control detection strength.
---

# METR: Image Watermarking with Large Number of Unique Messages

## Quick Facts
- arXiv ID: 2408.08340
- Source URL: https://arxiv.org/abs/2408.08340
- Reference count: 40
- Primary result: Watermarking algorithm that encodes multiple unique user IDs in diffusion model-generated images while maintaining robustness and image quality

## Executive Summary
METR is a watermarking algorithm for diffusion models that can embed multiple unique messages (e.g., user IDs) while maintaining robustness to attacks and image quality. Built on the Tree-Ring watermarking approach, METR encodes binary messages as concentric circles in the Fourier space of the initial noise, using a radius parameter to determine the number of possible messages and a scale parameter to control detection strength. The authors introduce a detection resolution metric to optimize these parameters. They also propose METR++, an extension for Latent Diffusion Models that combines METR with Stable Signature to further increase the number of encodable messages.

## Method Summary
METR encodes messages by mapping binary sequences to concentric circles in the Fourier space of initial noise, with circle radii from 1 to R. Detection uses DDIM inversion to recover initial noise and statistical tests on circle values to decode messages. The detection resolution metric optimizes the scale parameter S by computing detection distance differences between watermarked and non-watermarked images. METR++ extends this by combining METR with Stable Signature in Latent Diffusion Models, encoding group IDs in the VAE decoder while maintaining METR for user IDs within groups.

## Key Results
- METR achieves high watermark detection accuracy and message decryption rates comparable to Tree-Ring
- Detection resolution metric enables optimal parameter selection balancing robustness and image quality
- METR++ increases unique message capacity exponentially but is more vulnerable to attacks due to Stable Signature's lower robustness

## Why This Works (Mechanism)

### Mechanism 1
- Claim: METR encodes multiple unique messages by representing each bit as a concentric circle in the Fourier space of the initial noise.
- Mechanism: Binary message bits are mapped to concentric circles with radii from 1 to R. Circles with value 1 are set to +S, circles with value 0 are set to -S. This creates a pattern in Fourier space that is decoded by averaging values within each circle after inverse diffusion.
- Core assumption: The Fourier representation of initial noise is sufficiently stable across diffusion sampling to allow reliable detection and message recovery.
- Evidence anchors:
  - [abstract] "METR is built on the Tree-Ring watermarking algorithm, a technique that makes it possible to encode multiple distinct messages without compromising attack resilience or image quality."
  - [section] "In METR, messages consist of binary sequences encoded using concentric circles with radii increasing from 1 to ð‘…, where ð‘… is defined as the watermark radius. This radius is a fixed hyperparameter representing the number of bits in the message."
  - [corpus] Weak evidence - no direct mentions of concentric circle encoding in corpus papers.

### Mechanism 2
- Claim: The detection resolution metric enables optimal selection of the message scale parameter S to balance detectability and image quality.
- Mechanism: Detection resolution computes the difference in detection distances between watermarked and non-watermarked images. This metric is normalized by S and compared against a threshold (kSÂ² + bS) to ensure sufficient separation for reliable detection while maintaining image quality.
- Core assumption: The detection distance difference between watermarked and non-watermarked images is linearly related to S, allowing threshold-based parameter selection.
- Evidence anchors:
  - [section] "Detection Resolution metric computes the difference in detection distances between an image without a watermark x0 and an image with one x*0: Rdet(x0, x*0) = d(x0) - d(x*0)"
  - [section] "we computed g = Rdet/S for situations with a perfect detection of message, and it occurred that g = kS + b, where k and b are linear fit parameters."
  - [corpus] No direct evidence - corpus papers focus on different watermarking approaches without parameter optimization metrics.

### Mechanism 3
- Claim: METR++ extends METR by combining it with Stable Signature to encode group IDs, enabling exponential growth in unique message capacity.
- Mechanism: Messages are partitioned into groups of size 2^R. Each group is assigned a unique ID encoded via Stable Signature in the VAE decoder. Within each group, METR encodes the specific user ID. This creates 2^R * n total unique messages where n is the number of fine-tuned VAE decoders.
- Core assumption: The Stable Signature watermark remains detectable even when combined with the METR watermark in the same image generation pipeline.
- Evidence anchors:
  - [abstract] "We suggest a simple modification of METR, METR++. It combines METR with Stable Signature [24] and extends the amount of unique messages encrypted to as many as one might need."
  - [section] "METR++ can be adapted to any Latent Diffusion model and can encrypt approximately 2^r * n unique messages, where r is METR's watermark radius, and n is the number of fine-tuned VAE decoders."
  - [corpus] Weak evidence - corpus papers mention different watermarking approaches but don't discuss combined watermarking systems.

## Foundational Learning

- Concept: Fourier transforms and their stability in image generation
  - Why needed here: METR encodes messages in the Fourier space of initial noise, requiring understanding of how Fourier representations behave through the diffusion process.
  - Quick check question: What happens to the Fourier representation of an image when you apply a simple Gaussian blur? Does the high-frequency information remain detectable?

- Concept: Diffusion model inversion (DDIM Inversion)
  - Why needed here: METR uses DDIM Inversion to recover the initial noise from a generated image for watermark detection, which requires understanding the deterministic relationship between images and their initial noise.
  - Quick check question: If you generate an image with a specific prompt and then apply DDIM Inversion, will you always recover the exact same initial noise for that same model and sampling configuration?

- Concept: Statistical hypothesis testing for watermark detection
  - Why needed here: METR uses p-values from chi-squared tests to determine if a watermark is present, requiring understanding of statistical significance and false positive rates.
  - Quick check question: If you have a watermark detection p-value of 0.03 with a threshold of 0.05, what does this tell you about the likelihood that a watermark is present versus absent?

## Architecture Onboarding

- Component map: Stable Diffusion 2.1 -> Fourier transform -> Concentric circle encoder -> Inverse Fourier -> DDIM sampling -> Image generation -> DDIM Inversion -> Fourier transform -> Statistical detection -> Message recovery
- Critical path: Initial noise â†’ Fourier transform â†’ concentric circle encoding â†’ inverse Fourier â†’ DDIM sampling â†’ image generation â†’ DDIM Inversion â†’ Fourier transform â†’ statistical detection â†’ message recovery
- Design tradeoffs:
  - Higher R (radius) increases message capacity but degrades image quality
  - Higher S (scale) improves detection robustness but increases visible artifacts
  - METR++ increases message capacity exponentially but requires VAE decoder fine-tuning per group
- Failure signatures:
  - Low TPR with high FPR indicates detection threshold issues
  - Consistent message bit errors suggest Fourier pattern corruption during generation
  - Image quality degradation with visible ring artifacts indicates S too high
  - Group ID detection failures in METR++ suggest interference between watermark types
- First 3 experiments:
  1. Generate images with METR using varying R values (4, 8, 12, 16) and measure FID score degradation to find optimal R for 1024 messages
  2. Test METR watermark detection robustness under standard attacks (JPEG compression, Gaussian noise, rotation) to verify claimed resilience
  3. Implement METR++ with 2 groups and verify that both group ID and user ID can be correctly decoded from the same image

## Open Questions the Paper Calls Out

### Open Question 1
- Question: How does the quality of generated images vary with different METR messages?
- Basis in paper: [inferred] The paper mentions that the quality of images generated using an average METR message is comparable to those produced with the Tree-Ring watermark. However, it also notes the need to examine various combinations of binary values to ascertain whether certain messages with "extreme values" might significantly affect image quality.
- Why unresolved: The paper does not provide specific data or experiments comparing the image quality across different METR messages.
- What evidence would resolve it: Experiments comparing the image quality of generated images using different METR messages, especially those with extreme binary values.

### Open Question 2
- Question: What is the optimal balance between the number of unique messages that can be encoded and the watermark's robustness to attacks in METR++?
- Basis in paper: [explicit] The paper states that METR++ increases the potential number of encoded messages by the factor of fine-tuned VAE decoders. However, it also mentions that the robustness of METR++, in terms of word accuracy, is limited to the lesser robustness of the two watermarks (METR and Stable Signature).
- Why unresolved: The paper does not provide specific data or analysis on the trade-off between the number of unique messages and the watermark's robustness to attacks in METR++.
- What evidence would resolve it: Experiments analyzing the robustness of METR++ to attacks as the number of unique messages increases.

### Open Question 3
- Question: How does the Detection Resolution Metric perform in practice for selecting the optimal message scale S?
- Basis in paper: [explicit] The paper introduces the Detection Resolution Metric to capture the contrast between watermarked images and those without watermarks. However, it does not provide extensive experimental results or validation of the metric's effectiveness in practice.
- Why unresolved: The paper only provides a brief description of the algorithm and does not demonstrate its performance on a large dataset or in real-world scenarios.
- What evidence would resolve it: Extensive experiments evaluating the Detection Resolution Metric's effectiveness in selecting the optimal message scale S across various datasets and scenarios.

## Limitations

- METR's robustness to attacks is comparable to Tree-Ring but may not match state-of-the-art attack resilience
- METR++ significantly increases message capacity but at the cost of reduced overall robustness due to combining two watermarking methods
- The stability of Fourier patterns through the full diffusion process remains unproven for all image types and model configurations

## Confidence

- **High Confidence**: The general framework of using concentric circles in Fourier space for message encoding, as this follows established watermarking principles and is explicitly described in the paper.
- **Medium Confidence**: The effectiveness of the detection resolution metric for parameter optimization, as the linear relationship claim needs more empirical validation across diverse image types and models.
- **Low Confidence**: The robustness of METR++ under combined watermarking conditions, as the paper acknowledges increased vulnerability to attacks when combining METR with Stable Signature.

## Next Checks

1. **Fourier Pattern Stability Test**: Generate multiple images from the same initial noise with and without watermarks, then measure the consistency of concentric circle patterns in their Fourier representations after DDIM inversion.
2. **Parameter Optimization Validation**: Systematically vary S values across different image types and measure whether detection resolution follows the claimed linear relationship with S, identifying any breaking points.
3. **Combined Watermark Robustness**: Test METR++ images against the same attack suite used for METR alone, measuring whether the combined watermark system maintains acceptable detection rates while achieving the claimed exponential message capacity.