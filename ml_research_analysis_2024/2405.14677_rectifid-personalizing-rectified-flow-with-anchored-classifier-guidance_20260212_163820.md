---
ver: rpa2
title: 'RectifID: Personalizing Rectified Flow with Anchored Classifier Guidance'
arxiv_id: '2405.14677'
source_url: https://arxiv.org/abs/2405.14677
tags:
- guidance
- flow
- classifier
- rectified
- diffusion
- transformers
- self-attention
- retrieval-augmented-generation
- instruction-tuning
- parameter-efficient-finetuning
- mixture-of-experts
- chain-of-thought
core_contribution: The paper proposes a training-free method to personalize rectified
  flow models using classifier guidance. The core idea is to reformulate classifier
  guidance as a fixed-point problem by exploiting the straightness property of rectified
  flow, allowing flexible reuse of off-the-shelf image discriminators for identity
  preservation.
---

# RectifID: Personalizing Rectified Flow with Anchored Classifier Guidance

## Quick Facts
- arXiv ID: 2405.14677
- Source URL: https://arxiv.org/abs/2405.14677
- Reference count: 40
- Key outcome: Training-free method to personalize rectified flow models using classifier guidance

## Executive Summary
This paper addresses the challenge of personalizing image generation while preserving identity from reference images. The authors propose a training-free method that reformulates classifier guidance as a fixed-point problem, enabling the use of off-the-shelf image discriminators instead of requiring specialized noise-aware classifiers. The approach is further stabilized by anchoring the flow trajectory to a reference trajectory, providing convergence guarantees. Implemented on piecewise rectified flow with face and object discriminators, the method demonstrates superior identity preservation and prompt consistency across various personalization tasks without requiring domain-specific training data.

## Method Summary
The method builds on rectified flow models by reformulating classifier guidance as a fixed-point problem, allowing the use of pre-trained image discriminators for identity preservation. The key innovation is anchoring the classifier-guided trajectory to a reference trajectory, which improves solving stability and provides convergence guarantees. The approach is implemented on piecewise rectified flow models with 4 time windows, using off-the-shelf discriminators like ArcFace for faces and DINOv2 for objects. The method operates without requiring additional training data or domain-specific classifiers, making it flexible for various personalization tasks including faces, live subjects, and objects.

## Key Results
- Achieves superior identity preservation (up to 1.7x improvement in cosine similarity) compared to training-free baselines on face personalization
- Maintains better prompt consistency than training-based methods while achieving comparable identity preservation
- Demonstrates flexibility across multiple domains including faces, live subjects, and objects without requiring domain-specific training data

## Why This Works (Mechanism)

### Mechanism 1
Reformulating classifier guidance as a fixed-point problem enables the use of off-the-shelf image discriminators without requiring noise-aware classifiers. By exploiting the straightness property of rectified flow, intermediate classifier guidance terms can be bypassed, reducing the problem to solving for the trajectory endpoint z1 using only the clean image-based discriminator. The core assumption is that the rectified flow trajectory is ideally straight, allowing classifier guidance to be reformulated as a simple fixed-point problem concerning only trajectory endpoints.

### Mechanism 2
Anchoring the classifier-guided flow trajectory to a reference trajectory improves solving stability and provides convergence guarantees. By constraining the new trajectory to be straight and near the reference trajectory, the target velocity is anchored to a predetermined reference velocity, reducing drift and improving controllability during the solving process. The core assumption is that the two flow trajectories (with and without classifier guidance) are close and straight, allowing their difference to be estimated via first-order Taylor expansion.

### Mechanism 3
The anchored classifier guidance implicitly estimates intermediate classifier guidance using gradient backpropagation. The anchored classifier guidance can be interpreted as secretly estimating the intermediate classifier guidance with gradient backpropagation, connecting the approach to existing approximation practices. The core assumption is that the anchored classifier guidance preserves the straightness property of rectified flow, enabling gradient backpropagation interpretation.

## Foundational Learning

- **Ordinary Differential Equations (ODEs) and flow-based generative models**: Understanding how rectified flow uses ODEs to model the mapping from random noise to data samples is crucial. Quick check: How does the rectified flow objective (Eq. 2) differ from standard flow-based generative models?

- **Classifier guidance and noise-aware classifiers**: Understanding the limitation of vanilla classifier guidance (requiring noise-aware classifiers) is crucial for appreciating the proposed fixed-point solution. Quick check: What is the main limitation of vanilla classifier guidance that the paper aims to address?

- **Fixed-point iteration and convergence guarantees**: The proposed method relies on solving a fixed-point problem, and understanding convergence conditions is essential for implementation. Quick check: What condition must be satisfied for the Banach fixed-point theorem to guarantee convergence?

## Architecture Onboarding

- **Component map**: Base model (Piecewise rectified flow) -> Classifier (Off-the-shelf image discriminator) -> Detector (Face/object detector) -> Solver (Iterative algorithm)

- **Critical path**: 1) Initialize reference trajectory from base model, 2) Iteratively update reference trajectory and target trajectory, 3) Apply anchored classifier guidance to steer trajectory, 4) Generate final image from target trajectory endpoint

- **Design tradeoffs**: Accuracy vs. speed (more iterations improve identity consistency but increase computation time), Memory vs. accuracy (fewer sampling steps reduce memory usage but may affect generation quality), Generalization vs. specificity (using off-the-shelf discriminators provides flexibility but may be less effective than specialized classifiers)

- **Failure signatures**: Divergence (target trajectory drifts away from reference trajectory), Convergence to poor local optima (generated images lose prompt consistency or visual quality), Sensitivity to hyperparameters (large changes in identity consistency with small changes in guidance scale or iterations)

- **First 3 experiments**: 1) Baseline comparison (generate images without classifier guidance), 2) Fixed-point solution only (implement fixed-point solution without anchoring), 3) Full method with different discriminators (test with face, object, and style transfer guidance)

## Open Questions the Paper Calls Out

- **Open Question 1**: How does the stability of anchored classifier guidance change with different levels of curvature in the rectified flow trajectory? The paper only validates on piecewise rectified flow with 4 time windows, leaving uncertainty about performance with more curved trajectories.

- **Open Question 2**: What is the optimal guidance scale s for different types of discriminators (face, object, segmentation)? The paper uses a fixed guidance scale s = 1.0 but shows sensitivity to this parameter without exploring type-specific optimization.

- **Open Question 3**: How does anchored classifier guidance compare to training-based personalization methods when both have access to the same amount of domain-specific data? The paper only compares to training-based methods requiring extensive datasets, not methods using discriminators as training objectives.

## Limitations

- The fixed-point reformulation relies on the assumption of straightness in rectified flow trajectories, but empirical validation across diverse datasets is limited
- Convergence guarantees provided by anchoring assume that reference and target trajectories remain close, which may not hold for complex identity preservation tasks
- The method's generalization to non-face domains remains unproven beyond limited DreamBooth examples

## Confidence

- **High confidence**: The core mathematical formulation of anchored classifier guidance and its implementation details
- **Medium confidence**: Claims about superior identity preservation and prompt consistency, as these depend heavily on dataset-specific performance
- **Low confidence**: Generalization claims to arbitrary subjects and objects without domain-specific training data

## Next Checks

1. **Straightness verification**: Quantitatively measure trajectory straightness across different rectified flow models and datasets to validate the fundamental assumption enabling the fixed-point reformulation

2. **Convergence stress test**: Systematically vary guidance scales and iteration counts to identify conditions where anchoring fails to maintain trajectory closeness

3. **Cross-domain generalization**: Evaluate identity preservation performance on diverse subjects (animals, vehicles, artistic styles) beyond the presented face and DreamBooth examples to assess true training-free generalization